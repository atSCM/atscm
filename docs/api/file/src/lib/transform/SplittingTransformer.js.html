<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/lib/transform/SplittingTransformer.js | atscm API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/atSCM/atscm" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">config</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-config">config</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-path">path</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">init</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/init/InitTask.js~InitTask.html">InitTask</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/init/OptionsValidator.js~InitOptionsValidator.html">InitOptionsValidator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ConfigLangs">ConfigLangs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-InitOptions">InitOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-InitOptionsAsArray">InitOptionsAsArray</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/config</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/config/Atviseproject.js~Atviseproject.html">Atviseproject</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/gulp</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/gulp/PullStream.js~PullStream.html">PullStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/gulp/PushStream.js~PushStream.html">PushStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-watchForFileChanges">watchForFileChanges</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-watchForServerChanges">watchForServerChanges</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/init</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/init/Option.js~InitOption.html">InitOption</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/server</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/server/AtviseFile.js~AtviseFile.html">AtviseFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/server/Client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/server/NodeId.js~NodeId.html">NodeId</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/server/NodeStream.js~NodeStream.html">NodeStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/server/ReadStream.js~ReadStream.html">ReadStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/server/Session.js~Session.html">Session</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/server/Stream.js~Stream.html">Stream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/server/Watcher.js~SubscribeStream.html">SubscribeStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/server/Watcher.js~Watcher.html">Watcher</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/server/WriteStream.js~WriteStream.html">WriteStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DataTypeForExtension">DataTypeForExtension</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ExtensionForDataType">ExtensionForDataType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AtviseTypes">AtviseTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ReadStream.ReadResult">ReadStream.ReadResult</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/transform</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/transform/PartialTransformer.js~PartialTransformer.html">PartialTransformer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/transform/SplittingTransformer.js~CombineFilesCache.html">CombineFilesCache</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/transform/SplittingTransformer.js~SplittingTransformer.html">SplittingTransformer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/transform/Transformer.js~Transformer.html">Transformer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/transform/XMLTransformer.js~XMLTransformer.html">XMLTransformer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TransformDirection">TransformDirection</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">tasks</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-pull">pull</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-push">push</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-watch">watch</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">transform</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/transform/DisplayTransformer.js~DisplayTransformer.html">DisplayTransformer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/transform/Mapping.js~MappingTransformer.html">MappingTransformer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/transform/ScriptTransformer.js~ScriptTransformer.html">ScriptTransformer</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">typedef/external</div><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-inquirer~PromptType">inquirer~PromptType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-inquirer~Validator">inquirer~Validator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/sboudrias/Inquirer.js">Inquirer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://node-opcua.github.io/api_doc/">node-opcua</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://node-opcua.github.io/api_doc/classes/ClientSession.html">node-opcua~ClientSession</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://node-opcua.github.io/api_doc/classes/ClientSubscription.html">node-opcua~ClientSubscription</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/node-opcua/node-opcua/blob/master/schemas/DataType_enum.js">node-opcua~DataType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://node-opcua.github.io/api_doc/classes/DataValue.html">node-opcua~DataValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://node-opcua.github.io/api_doc/classes/NodeId.html">node-opcua~NodeId</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://node-opcua.github.io/api_doc/classes/NodeIdType.html">node-opcua~NodeIdType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://node-opcua.github.io/api_doc/classes/OPCUAClient.html">node-opcua~OPCUAClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://node-opcua.github.io/api_doc/classes/ReferenceDescription.html">node-opcua~ReferenceDescription</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/node-opcua/node-opcua/blob/master/schemas/VariantArrayType_enum.js">node-opcua~VariantArrayType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/gulpjs/vinyl#new-vinyloptions">vinyl~File</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/Leonidas-from-XIV/node-xml2js#options-for-the-builder-class">xml2js~Builder</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">util</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cleanup">cleanup</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/lib/transform/SplittingTransformer.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { readdir } from &apos;fs&apos;;
import { extname, basename, join } from &apos;path&apos;;
import Logger from &apos;gulplog&apos;;
import PartialTransformer from &apos;./PartialTransformer&apos;;
import AtviseFile from &apos;../server/AtviseFile&apos;;

/**
 * Determines which files are needed to create a combined file and stores these files as long as
 * some of them are missing.
 */
export class CombineFilesCache {

  /**
   * Creates a new DisplayCache.
   */
  constructor() {
    /**
     * The files caches for the given path.
     * @type {Map&lt;String, vinyl~File&gt;}
     */
    this._files = {};

    /**
     * The extensions of the files required.
     * @type {String[]}
     */
    this._required = {};
  }

  /**
   * Returns the extensions of the missing files for the given `dirname`.
   * @param {String} dirname The cache key to look for.
   * @return {String[]} Extensions of the missing files.
   */
  missingExtensions(dirname) {
    const required = this._required[dirname];
    const files = this._files[dirname];

    return required.filter(ext =&gt; files[ext] === undefined);
  }

  /**
   * Checks if, when `file` is added, all required files are cached.
   * @param {vinyl~File} file The file to add before checking.
   * @param {function(err: ?Error, files: ?Map&lt;String, vinyl~File&gt;)} callback Called with the error
   * that occured while checking or all files related to `file` if all required files are already
   * cached.
   */
  gotAllFiles(file, callback) {
    const dirname = file.dirname;

    if (!this._required[dirname]) {
      readdir(dirname, (err, files) =&gt; {
        if (err) {
          callback(err);
        } else {
          this._files[dirname] = {};
          this._required[dirname] = files
            .filter(name =&gt; name[0] !== &apos;.&apos;)
            .map(name =&gt; extname(name));

          this.gotAllFiles(file, callback);
        }
      });
    } else {
      this._files[dirname][file.extname] = file;

      if (this.missingExtensions(dirname).length === 0) {
        const files = this._files[dirname];
        callback(null, files);

        delete this._files[dirname];
        delete this._required[dirname];
      } else {
        callback(null);
      }
    }
  }

}

/**
 * A transformer that splits files into multiple others.
 * @abstract
 */
export default class SplittingTransformer extends PartialTransformer {

  /**
   * Creates a new SplittingTransformer.
   * @param {Object} options The options to apply.
   */
  constructor(options) {
    super(options);

    /**
     * The cache used when collecting files to combine.
     * @type {CombineFilesCache}
     */
    this._combineFilesCache = new CombineFilesCache();
  }

  /**
   * Creates a combined file from the cached split files.
   * @param {Map&lt;String, AtviseFile&gt;} files The cached files stored against their extensions.
   * @param {AtviseFile} lastFile The last file collected. This is the only file guaranteed to be
   * set, therefore us if for error messages, etc.
   * @param {function(err: ?Error, data: ?AtviseFile)} callback Should be called with any errors
   * that occur while combining the files, or optionally the resulting file.
   * @abstract
   */
  createCombinedFile(files, lastFile, callback) { // eslint-disable-line no-unused-vars
    throw new Error(
      &apos;SplittingTransformer#createCombinedFile must be implemented by all subclasses&apos;
    );
  }

  /**
   * Calls {@link SplittingTransformer#createCombinedFile} as soon as all dependencies are
   * required files are cached.
   * @param {AtviseFile} file The read file.
   * @param {String} enc The encoding used.
   * @param {function(err: ?Error, data: ?AtviseFile)} callback Called with the error occured while
   * caching files or creating the combined file or optionally the resulting combined file.
   */
  transformFromFilesystem(file, enc, callback) {
    this._combineFilesCache.gotAllFiles(file, (err, allFiles) =&gt; {
      if (err) {
        callback(err);
      } else if (allFiles) {
        this.createCombinedFile(allFiles, file, callback);
      } else {
        callback(null);
      }
    });
  }

  /**
   * Splits a {@link vinyl~File}: The resulting is a clone of the input file, with a different path.
   * @param {vinyl~File} file The file to split.
   * @param {?String} newExtension The extension the resulting file gets.
   * @return {vinyl~File} The resulting file.
   * @example
   * // Assuming that `original` is a File with the path &quot;path/to/file.type.xml&quot;:
   * const result = SplittingTransformer.splitFile(original, &apos;.another&apos;);
   * // `result` is a new File, with the contents of `original` and the path
   * // &quot;path/to/file.type/file.another&quot;
   */
  static splitFile(file, newExtension) {
    const newFile = file.clone();

    newFile.basename = `${newFile.stem}/${newFile.stem}`;
    newFile.extname = newExtension;

    return newFile;
  }

  /**
   * Combines split files to a single one.
   * @param {vinyl~File[]} files The files to combine.
   * @param {String} newExtension The extension the resulting file gets.
   * @return {vinyl~File} The resulting file.
   */
  static combineFiles(files, newExtension) {
    const newFile = files[0].clone();

    newFile.path = `${newFile.dirname}${newExtension}`;

    return newFile;
  }

  /**
   * If there are any missing files this method loads these files and calls
   * {SplittingTransformer#createCombinedFile} with them.
   * @param {function(err: ?Error)} callback Called with the error that occurred while loading
   * missing files.
   */
  _flush(callback) {
    const missingDirnames = Object.keys(this._combineFilesCache._files);

    if (missingDirnames.length &gt; 0) {
      Promise.all(
        missingDirnames.map(dirname =&gt; {
          const files = this._combineFilesCache._files[dirname];
          const firstFile = files[Object.keys(files)[0]];

          const missing = this._combineFilesCache.missingExtensions(dirname);
          const stem = basename(dirname, extname(dirname));
          const paths = missing.map(ext =&gt; join(dirname, &apos;/&apos;, `${stem}${ext}`));

          delete this._combineFilesCache._files[dirname];
          delete this._combineFilesCache._required[dirname];

          Logger.debug(&apos;Loading&apos;, paths.length, &apos;required file(s)&apos;);

          return Promise.all(
            paths.map((path, i) =&gt; AtviseFile.read({
              cwd: firstFile.cwd,
              base: firstFile.base,
              path,
            })
              .then(file =&gt; {
                files[missing[i]] = file;
              })
            )
          )
            .then(() =&gt; new Promise((resolve, reject) =&gt; {
              this.createCombinedFile(files, firstFile, (err, file) =&gt; {
                if (err) {
                  reject(err);
                } else {
                  this.push(file);

                  resolve(file);
                }
              });
            }));
        })
      )
        .then(files =&gt; Logger.debug(&apos;Created&apos;, files.length, &apos;additional file(s)&apos;))
        .then(() =&gt; callback())
        .catch(err =&gt; callback(err));
    } else {
      callback();
    }
  }

}

</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
