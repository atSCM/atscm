{"version":3,"sources":["../../../src/lib/transform/XMLTransformer.js"],"names":["XMLTransformer","SplittingTransformer","constructor","options","build","object","buildOptions","declaration","Object","assign","attributes","version","encoding","standalone","root","elements","find","isElement","addOnTop","parent","name","node","unshift","attributeValueFn","val","replace","_fromDBBuilder","xml","compact","spaces","EOL","_fromFilesystemBuilder","builder","direction","TransformDirection","FromDB","decodeContents","textTagIssues","Set","doc","value","stringValue","textFn","text","parentElement","match","siblingElements","filter","length","add","tab","repeat","size","Logger","warn","nodeId","Array","from","map","p","join","encodeContents"],"mappings":"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","sourcesContent":["import { EOL } from 'os';\nimport { xml2js, js2xml } from 'xml-js';\nimport Logger from 'gulplog';\nimport { isElement, removeChild, displayPath, elementPath } from '../helpers/xml';\nimport { TransformDirection } from './Transformer';\nimport SplittingTransformer from './SplittingTransformer';\n\n/**\n * A transformer used to transform XML documents.\n */\nexport default class XMLTransformer extends SplittingTransformer {\n\n  /**\n   * Creates a new XMLTransformer based on some options.\n   * @param {Object} options The options to use.\n   */\n  constructor(options) {\n    super(options);\n\n    function build(object, buildOptions) {\n      if (!object.declaration) {\n        Object.assign(object, {\n          declaration: {\n            attributes: { version: '1.0', encoding: 'UTF-8', standalone: 'no' },\n          },\n        });\n      }\n\n      const root = object.elements.find(isElement);\n\n      function addOnTop(parent, name) {\n        const node = removeChild(parent, name);\n\n        if (node) {\n          parent.elements.unshift(node);\n        }\n      }\n\n      if (root.elements) {\n        addOnTop(root, 'metadata');\n        addOnTop(root, 'defs');\n        addOnTop(root, 'title');\n      }\n\n      return js2xml(object, Object.assign(buildOptions, {\n        attributeValueFn(val) {\n          return val\n            .replace(/&(?!(amp|quot);)/g, '&amp;')\n            .replace(/</g, '&lt;');\n        },\n      }));\n    }\n\n    // eslint-disable-next-line jsdoc/require-param\n    /**\n     * The builder to use with direction {@link TransformDirection.FromDB}.\n     * @type {function(object: Object): string}\n     */\n    this._fromDBBuilder = object => {\n      const xml = build(object, { compact: false, spaces: 2 });\n      return xml.replace(/\\r?\\n/g, EOL);\n    };\n\n    // eslint-disable-next-line jsdoc/require-param\n    /**\n     * The builder to use with direction {@link TransformDirection.FromFilesystem}.\n     * @type {function(object: Object): string}\n     */\n    this._fromFilesystemBuilder = object => {\n      const xml = build(object, { compact: false, spaces: 1 });\n      return xml.replace(/\\r?\\n/g, '\\n');\n    };\n  }\n\n  /**\n   * Returns the XML builder to use based on the current {@link Transformer#direction}.\n   * @type {function(object: Object): string}\n   */\n  get builder() {\n    return this.direction === TransformDirection.FromDB ?\n      this._fromDBBuilder :\n      this._fromFilesystemBuilder;\n  }\n\n  /**\n   * Parses XML in a node's contents.\n   * @param {Node} node The node to process.\n   */\n  decodeContents(node) {\n    const textTagIssues = new Set();\n\n    const doc = xml2js(this.direction === TransformDirection.FromDB ?\n      node.value.value :\n      node.stringValue, {\n      compact: false,\n      textFn(text, parentElement) {\n        if (text.match(/\\r?\\n *$/)) {\n          const siblingElements = parentElement.elements.filter(isElement);\n\n          if (siblingElements.length) {\n            textTagIssues.add(displayPath(parentElement));\n\n            // Correct indent\n            const tab = ' '.repeat(this.direction === TransformDirection.FromDB ? 2 : 1);\n\n            return text.replace(/\\s*\\r?\\n *$/,\n              `${EOL}${tab.repeat(elementPath(parentElement).length - 1)}`\n            );\n          }\n        }\n\n        return text;\n      },\n    });\n\n    if (textTagIssues.size) {\n      Logger.warn(`Mixed text and tags inside '${node.nodeId}': This can lead to weird behaviour.\n  - Affected paths: ${Array.from(textTagIssues).map(p => `'${p}'`).join(',\\n    ')}\n  - See: https://github.com/atSCM/atscm/issues/239`);\n    }\n\n    return doc;\n  }\n\n  /**\n   * Builds an XML string from an object.\n   * @param {Object} object The object to encode.\n   */\n  encodeContents(object) {\n    return this.builder(object);\n  }\n\n}\n"],"file":"XMLTransformer.js"}