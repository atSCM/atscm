{"version":3,"sources":["../../../src/lib/server/AddReferencesStream.js"],"names":["serverNodes","Set","ServerRelatedNodes","map","id","value","AddReferencesStream","constructor","options","_retry","referencesToAdd","file","additionalReferences","Object","assign","references","toParent","HasTypeDefinition","HasModellingRule","dependenciesFor","refs","values","reduce","deps","nodes","concat","filter","has","scriptId","NodeIdType","STRING","scriptParameters","additionalKeys","keys","length","paramObjString","dataType","String","JSON","stringify","nodeId","type","referenceIdValue","items","i","toJSON","processErrorMessage","handleOutputArguments","outArgs","callback","Good","Error","failures","retryKey","delete","join","add","once","write"],"mappings":"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","file":"AddReferencesStream.js","sourcesContent":["import { DataType } from 'node-opcua/lib/datamodel/variant';\nimport { StatusCodes } from 'node-opcua/lib/datamodel/opcua_status_code';\nimport { ReferenceTypeIds } from 'node-opcua/lib/opcua_node_ids';\nimport NodeId from '../model/opcua/NodeId';\nimport Atviseproject from '../config/Atviseproject';\nimport CallScriptStream from './scripts/CallScriptStream';\nimport { waitForDependencies } from './WaitingStream';\n\nconst serverNodes = new Set(Atviseproject.ServerRelatedNodes.map(id => id.value));\n\n/**\n * A stream that adds non-standard references to nodes when pushed.\n */\nexport default class AddReferencesStream extends waitForDependencies(CallScriptStream) {\n\n  /**\n   * Creates a new stream for adding references to pushed nodes.\n   * @param {Object} options The options to pass to the {@link CallScriptStream}.\n   */\n  constructor(options) {\n    super(options);\n\n    /**\n     * A stack of {@link NodeId#value}s to be retried afterwards.\n     * @type {Set<string>}\n     */\n    this._retry = new Set();\n  }\n\n  /**\n   * Returns the references that need to be set for a file.\n   * @param {AtviseFile} file The file to check.\n   * @return {Object} The files's references.\n   */\n  referencesToAdd(file) {\n    const additionalReferences = Object.assign({}, file.references);\n    delete additionalReferences.toParent;\n    delete additionalReferences.HasTypeDefinition;\n    delete additionalReferences.HasModellingRule;\n\n    return additionalReferences;\n  }\n\n  /**\n   * Returns the referenced nodes that should be processed before the given file.\n   * @param {AtviseFile} file The file to check.\n   * @return {NodeId[]} The files dependencies.\n   */\n  dependenciesFor(file) {\n    const refs = this.referencesToAdd(file);\n\n    return Object.values(refs)\n      .reduce((deps, nodes) => deps.concat(nodes), [])\n      .filter(({ value }) => !serverNodes.has(value));\n  }\n\n  /**\n   * Id of the *CreateNode* script added with `atscm import`.\n   * @type {NodeId}\n   */\n  get scriptId() {\n    return new NodeId(NodeId.NodeIdType.STRING,\n      'SYSTEM.LIBRARY.ATVISE.SERVERSCRIPTS.atscm.AddReferences',\n      1\n    );\n  }\n\n  /**\n   * The options required to add references to the node for the given file.\n   * @param {AtviseFile} file The processed file.\n   * @return {Object} The options passed to the *AddReferences* script.\n   */\n  scriptParameters(file) {\n    const additionalReferences = this.referencesToAdd(file);\n\n    const additionalKeys = Object.keys(additionalReferences);\n\n    if (additionalKeys.length > 0) {\n      return {\n        paramObjString: {\n          dataType: DataType.String,\n          value: JSON.stringify({\n            nodeId: file.nodeId,\n            references: additionalKeys\n              .map(type => ({\n                referenceIdValue: ReferenceTypeIds[type],\n                items: additionalReferences[type]\n                  .map(i => i.toJSON()),\n              })),\n          }),\n        },\n      };\n    }\n\n    // No need to add references\n    return null;\n  }\n\n  /**\n   * Prints an error message telling that adding one or more references failed.\n   * @param {AtviseFile} file The file who's node could not be created.\n   * @return {string} The resulting error message.\n   */\n  processErrorMessage(file) {\n    return `Error adding references to node ${file.nodeId.value}`;\n  }\n\n  /**\n   * Handles the results of a script call.\n   * @param {AtviseFile} file The file the script was called with.\n   * @param {node-opcua~Variant[]} outArgs The raw method results.\n   * @param {function(err: Error)} callback Called once finished.\n   */\n  handleOutputArguments(file, outArgs, callback) {\n    if (outArgs[0].value !== StatusCodes.Good) {\n      callback(new Error(outArgs[1].value));\n    } else {\n      const [{ value: failures }] = outArgs[3].value;\n\n      if (failures && failures.length) {\n        const retryKey = file.nodeId.value;\n\n        if (this._retry.has(retryKey)) {\n          this._retry.delete(retryKey);\n          callback(new Error(`Failed to create references to ${failures.join(', ')}`));\n        } else {\n          this._retry.add(retryKey);\n          callback(null);\n\n          this.once('drained', () => {\n            this.write(file);\n          });\n        }\n\n        return;\n      }\n\n      callback(null);\n    }\n  }\n\n}\n"]}