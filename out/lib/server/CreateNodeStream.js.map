{"version":3,"sources":["../../../src/lib/server/CreateNodeStream.js"],"names":["CreateNodeStream","scriptId","NodeIdType","STRING","scriptParameters","file","options","nodeId","parentNodeId","parent","nodeClass","value","typeDefinition","browseName","reference","references","toParent","modellingRule","HasModellingRule","Variable","dataType","valueRank","arrayType","createNodeValue","paramObjString","String","JSON","stringify","processErrorMessage","handleOutputArguments","outArgs","callback","Good","Error","createdNode","createFailed","warn","toString","debug","push"],"mappings":";;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;;;AAEA;;;AAGe,MAAMA,gBAAN,oCAAgD;;AAE7D;;;;AAIA,MAAIC,QAAJ,GAAe;AACb,WAAO,qBAAW,iBAAOC,UAAP,CAAkBC,MAA7B,EACL,sDADK,EAEL,CAFK,CAAP;AAID;;AAED;;;;;AAKAC,mBAAiBC,IAAjB,EAAuB;AACrB,UAAMC,UAAU;AACdC,cAAQF,KAAKE,MADC;AAEdC,oBAAcH,KAAKE,MAAL,CAAYE,MAFZ;AAGdC,iBAAWL,KAAKK,SAAL,CAAeC,KAHZ;AAIdC,sBAAgBP,KAAKO,cAAL,CAAoBD,KAJtB;AAKdE,kBAAYR,KAAKE,MAAL,CAAYM,UALV;;AAOd;AACAC,iBAAWT,KAAKU,UAAL,CAAgBC,QAAhB,IAA4BX,KAAKU,UAAL,CAAgBC,QAAhB,CAAyBL,KARlD;AASdM,qBAAeZ,KAAKU,UAAL,CAAgBG,gBAAhB,IAAoCb,KAAKU,UAAL,CAAgBG,gBAAhB,CAAiC,CAAjC;AATrC,KAAhB;;AAYA,QAAIb,KAAKK,SAAL,CAAeC,KAAf,KAAyB,qBAAUQ,QAAV,CAAmBR,KAAhD,EAAuD;AACrDL,cAAQc,QAAR,GAAmBf,KAAKe,QAAL,CAAcT,KAAjC;AACAL,cAAQe,SAAR,GAAoBhB,KAAKiB,SAAL,CAAeX,KAAnC;AACAL,cAAQK,KAAR,GAAgBN,KAAKkB,eAArB;AACD;;AAED,WAAO;AACLC,sBAAgB;AACdJ,kBAAU,oBAASK,MADL;AAEdd,eAAOe,KAAKC,SAAL,CAAerB,OAAf;AAFO;AADX,KAAP;AAMD;;AAED;;;;;AAKAsB,sBAAoBvB,IAApB,EAA0B;AACxB,WAAQ,uBAAsBA,KAAKE,MAAL,CAAYI,KAAM,EAAhD;AACD;;AAED;;;;;;AAMAkB,wBAAsBxB,IAAtB,EAA4ByB,OAA5B,EAAqCC,QAArC,EAA+C;AAC7C,QAAID,QAAQ,CAAR,EAAWnB,KAAX,KAAqB,uBAAYqB,IAArC,EAA2C;AACzCD,eAAS,IAAIE,KAAJ,CAAUH,QAAQ,CAAR,EAAWnB,KAArB,CAAT;AACD,KAFD,MAEO;AACL,YAAM,CAAC,EAAEA,OAAOuB,WAAT,EAAD,EAAyB,EAAEvB,OAAOwB,YAAT,EAAzB,IAAoDL,QAAQ,CAAR,EAAWnB,KAArE;;AAEA,UAAIwB,YAAJ,EAAkB;AAChB,0BAAOC,IAAP,CAAY,uBAAZ,EAAqC/B,KAAKE,MAAL,CAAY8B,QAAZ,EAArC;AACD,OAFD,MAEO,IAAIH,WAAJ,EAAiB;AACtB,0BAAOI,KAAP,CAAa,cAAb,EAA6BjC,KAAKE,MAAL,CAAY8B,QAAZ,EAA7B;AACA,aAAKE,IAAL,CAAUlC,IAAV;AACD,OAHM,MAGA;AACL,0BAAOiC,KAAP,CAAa,MAAb,EAAqBjC,KAAKE,MAAL,CAAY8B,QAAZ,EAArB,EAA6C,gBAA7C;AACA,aAAKE,IAAL,CAAUlC,IAAV;AACD;;AAED0B,eAAS,IAAT;AACD;AACF;;AA9E4D;kBAA1C/B,gB","file":"CreateNodeStream.js","sourcesContent":["import { StatusCodes, DataType, NodeClass } from 'node-opcua';\nimport Logger from 'gulplog';\nimport NodeId from '../model/opcua/NodeId';\nimport CallScriptStream from './scripts/CallScriptStream';\n\n/**\n * A stream that creates OPC-UA nodes for the passed {@link AtviseFiles}s.\n */\nexport default class CreateNodeStream extends CallScriptStream {\n\n  /**\n   * Id of the *CreateNode* script added with `atscm import`.\n   * @type {NodeId}\n   */\n  get scriptId() {\n    return new NodeId(NodeId.NodeIdType.STRING,\n      'SYSTEM.LIBRARY.ATVISE.SERVERSCRIPTS.atscm.CreateNode',\n      1\n    );\n  }\n\n  /**\n   * The options required to create a node for the given file.\n   * @param {AtviseFile} file The processed file.\n   * @return {Object} The options passed to the *CreateNode* script.\n   */\n  scriptParameters(file) {\n    const options = {\n      nodeId: file.nodeId,\n      parentNodeId: file.nodeId.parent,\n      nodeClass: file.nodeClass.value,\n      typeDefinition: file.typeDefinition.value,\n      browseName: file.nodeId.browseName,\n\n      // Optional\n      reference: file.references.toParent && file.references.toParent.value,\n      modellingRule: file.references.HasModellingRule && file.references.HasModellingRule[0],\n    };\n\n    if (file.nodeClass.value === NodeClass.Variable.value) {\n      options.dataType = file.dataType.value;\n      options.valueRank = file.arrayType.value;\n      options.value = file.createNodeValue;\n    }\n\n    return {\n      paramObjString: {\n        dataType: DataType.String,\n        value: JSON.stringify(options),\n      },\n    };\n  }\n\n  /**\n   * Prints an error message telling that creating a node failed.\n   * @param {AtviseFile} file The file who's node could not be created.\n   * @return {string} The resulting error message.\n  */\n  processErrorMessage(file) {\n    return `Error creating node ${file.nodeId.value}`;\n  }\n\n  /**\n   * Handles the results of a script call.\n   * @param {AtviseFile} file The file the script was called with.\n   * @param {node-opcua~Variant[]} outArgs The raw method results.\n   * @param {function(err: Error)} callback Called once finished.\n   */\n  handleOutputArguments(file, outArgs, callback) {\n    if (outArgs[0].value !== StatusCodes.Good) {\n      callback(new Error(outArgs[1].value));\n    } else {\n      const [{ value: createdNode }, { value: createFailed }] = outArgs[3].value;\n\n      if (createFailed) {\n        Logger.warn('Failed to create node', file.nodeId.toString());\n      } else if (createdNode) {\n        Logger.debug('Created node', file.nodeId.toString());\n        this.push(file);\n      } else {\n        Logger.debug('Node', file.nodeId.toString(), 'already exists');\n        this.push(file);\n      }\n\n      callback(null);\n    }\n  }\n\n}\n"]}