{"version":3,"sources":["../../../../src/lib/server/scripts/CallMethodStream.js"],"names":["CallMethodStream","QueueStream","methodId","Error","methodBaseId","parent","inputArguments","file","callRequest","args","objectId","handleOutputArguments","outputArgs","callback","processErrorMessage","toString","relative","processChunk","handleErrors","request","StatusCodes","Good","done","session","call","err","result","statusCode","value","outputArguments","outputError","e"],"mappings":";;;;;;;AAAA;;AACA;;;;AAEA;;;;AAIe,MAAMA,gBAAN,SAA+BC,oBAA/B,CAA2C;AAExD;;;;AAIA,MAAIC,QAAJ,GAAe;AACb,UAAM,IAAIC,KAAJ,CAAU,uCAAV,CAAN;AACD;AAED;;;;;;;AAKA,MAAIC,YAAJ,GAAmB;AACjB,WAAO,KAAKF,QAAL,CAAcG,MAArB;AACD;AAED;;;;;;;;AAMAC,EAAAA,cAAc,CAACC,IAAD,EAAO;AAAE;AACrB,WAAO,EAAP;AACD;AAED;;;;;;;AAKAC,EAAAA,WAAW,CAACD,IAAD,EAAO;AAChB,UAAME,IAAI,GAAG,KAAKH,cAAL,CAAoBC,IAApB,CAAb;;AAEA,QAAIE,IAAI,KAAK,IAAb,EAAmB;AACjB,aAAO,IAAP;AACD;;AAED,WAAO;AACLC,MAAAA,QAAQ,EAAE,KAAKN,YADV;AAELF,MAAAA,QAAQ,EAAE,KAAKA,QAFV;AAGLI,MAAAA,cAAc,EAAEG;AAHX,KAAP;AAKD;AAED;;;;;;;;;AASA;;;AACAE,EAAAA,qBAAqB,CAACJ,IAAD,EAAOK,UAAP,EAAmBC,QAAnB,EAA6B;AAChD,UAAM,IAAIV,KAAJ,CAAU,uCAAV,CAAN;AACD;AAED;;;;;;;AAKAW,EAAAA,mBAAmB,CAACP,IAAD,EAAO;AACxB,WAAQ,iBAAgB,KAAKL,QAAL,CAAca,QAAd,EAAyB,QAAOR,IAAI,CAACS,QAAS,EAAtE;AACD;AAED;;;;;;;;AAMAC,EAAAA,YAAY,CAACV,IAAD,EAAOW,YAAP,EAAqB;AAC/B,QAAI;AACF,YAAMC,OAAO,GAAG,KAAKX,WAAL,CAAiBD,IAAjB,CAAhB;;AAEA,UAAI,CAACY,OAAL,EAAc;AACZD,QAAAA,YAAY,CAAC,IAAD,EAAOE,+BAAYC,IAAnB,EAAyBC,IAAI,IAAIA,IAAI,EAArC,CAAZ;AACA;AACD;;AAED,WAAKC,OAAL,CAAaC,IAAb,CAAkB,CAACL,OAAD,CAAlB,EAA6B,CAACM,GAAD,EAAM,CAACC,MAAD,IAAW,EAAjB,KAAwB;AACnD,YAAID,GAAJ,EAAS;AACPP,UAAAA,YAAY,CAACO,GAAD,CAAZ;AACD,SAFD,MAEO,IAAIC,MAAM,CAACC,UAAP,CAAkBC,KAAlB,KAA4BR,+BAAYC,IAAZ,CAAiBO,KAAjD,EAAwD;AAC7DV,UAAAA,YAAY,CAACO,GAAD,EAAMC,MAAM,CAACC,UAAb,EAAyBL,IAAI,IAAIA,IAAI,EAArC,CAAZ;AACD,SAFM,MAEA;AACL,eAAKX,qBAAL,CAA2BJ,IAA3B,EAAiCmB,MAAM,CAACG,eAAxC,EAAyDC,WAAW,IAAI;AACtEZ,YAAAA,YAAY,CAACY,WAAD,EAAcV,+BAAYC,IAA1B,EAAgCC,IAAI,IAAIA,IAAI,EAA5C,CAAZ;AACD,WAFD;AAGD;AACF,OAVD;AAWD,KAnBD,CAmBE,OAAOS,CAAP,EAAU;AACVb,MAAAA,YAAY,CAACa,CAAD,CAAZ;AACD;AACF;;AApGuD","sourcesContent":["import { StatusCodes } from 'node-opcua/lib/datamodel/opcua_status_code';\nimport QueueStream from '../QueueStream';\n\n/**\n * A stream that calls an OPC-UA method for all input files.\n * @abstract\n */\nexport default class CallMethodStream extends QueueStream {\n\n  /**\n   * **Must be implemented in all subclasses:** The {@link NodeId} of the method to call.\n   * @type {NodeId} The method's id.\n   */\n  get methodId() {\n    throw new Error('Must be implemented in all subclasses');\n  }\n\n  /**\n   * The {@link NodeId} of the object from which the method should get called. Defaults to the value\n   * of {@link NodeId#parent} of {@link CallMethodStream#methodId}.\n   * @type {NodeId} The call-object's id.\n   */\n  get methodBaseId() {\n    return this.methodId.parent;\n  }\n\n  /**\n   * The input arguments the method should be called with for a file. Needs to be overridden by\n   * subclasses in most cases. Returning `null` indicates no method call is needed.\n   * @param {vinyl~File} file The file beeing processed.\n   * @return {?node-opcua~Variant[]} The resulting input arguments.\n   */\n  inputArguments(file) { // eslint-disable-line @typescript-eslint/no-unused-vars\n    return [];\n  }\n\n  /**\n   * Creates a call method request object for a file.\n   * @param {vinyl~File} file The file beeing processed.\n   * @return {?node-opcua~CallMethodRequest} The resulting call request.\n   */\n  callRequest(file) {\n    const args = this.inputArguments(file);\n\n    if (args === null) {\n      return null;\n    }\n\n    return {\n      objectId: this.methodBaseId,\n      methodId: this.methodId,\n      inputArguments: args,\n    };\n  }\n\n  /**\n   * **Must be implemented by all subclasses:** If the method call returns a status code of\n   * *{@link node-opcua~StatusCodes}.Good*, this method decides if the output matches the expected\n   * results.\n   * @param {vinyl~File} file The file beeing processed.\n   * @param {node-opcua~Variant[]} outputArgs The output arguments.\n   * @param {function(err: Error)} callback Call this method with an error to indicate the method\n   * call didn't work as expected.\n   */\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  handleOutputArguments(file, outputArgs, callback) {\n    throw new Error('Must be implemented in all subclasses');\n  }\n\n  /**\n   * Returns an error message specifically for the given file.\n   * @param {vinyl~File} file The file to generate the error message for.\n   * @return {string} The specific error message.\n   */\n  processErrorMessage(file) {\n    return `Error running ${this.methodId.toString()} for ${file.relative}`;\n  }\n\n  /**\n   * Performs an opcua method call for the given file.\n   * @param {vinyl~File} file The file being processed.\n   * @param {function(err: Error, status: node-opcua~StatusCodes, success: function)} handleErrors\n   * The error handler to call. See {@link QueueStream#processChunk} for details.\n   */\n  processChunk(file, handleErrors) {\n    try {\n      const request = this.callRequest(file);\n\n      if (!request) {\n        handleErrors(null, StatusCodes.Good, done => done());\n        return;\n      }\n\n      this.session.call([request], (err, [result] = []) => {\n        if (err) {\n          handleErrors(err);\n        } else if (result.statusCode.value !== StatusCodes.Good.value) {\n          handleErrors(err, result.statusCode, done => done());\n        } else {\n          this.handleOutputArguments(file, result.outputArguments, outputError => {\n            handleErrors(outputError, StatusCodes.Good, done => done());\n          });\n        }\n      });\n    } catch (e) {\n      handleErrors(e);\n    }\n  }\n\n}\n"],"file":"CallMethodStream.js"}