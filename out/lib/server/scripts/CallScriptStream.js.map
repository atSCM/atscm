{"version":3,"sources":["../../../../src/lib/server/scripts/CallScriptStream.js"],"names":["CallScriptStream","CallMethodStream","methodId","NodeId","NodeIdType","STRING","scriptId","Error","scriptBaseId","parent","scriptParameters","file","inputArguments","params","paramNames","Object","keys","dataType","DataType","value","String","arrayType","VariantArrayType","Array","Variant","map","key","processErrorMessage","relative","processChunk","handleErrors","err","status","success","processedStatus","atscmScript","match","StatusCodes","BadMethodInvalid","description"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;;;AAEA;;;;AAIe,MAAMA,gBAAN,SAA+BC,yBAA/B,CAAgD;AAE7D;;;;AAIA,MAAIC,QAAJ,GAAe;AACb,WAAO,IAAIC,eAAJ,CAAWA,gBAAOC,UAAP,CAAkBC,MAA7B,EAAqC,iCAArC,EAAwE,CAAxE,CAAP;AACD;AAED;;;;;;;AAKA,MAAIC,QAAJ,GAAe;AACb,UAAM,IAAIC,KAAJ,CAAU,uCAAV,CAAN;AACD;AAED;;;;;;AAIA,MAAIC,YAAJ,GAAmB;AACjB,WAAO,KAAKF,QAAL,CAAcG,MAArB;AACD;AAED;;;;;;;AAKAC,EAAAA,gBAAgB,CAACC,IAAD,EAAO;AAAE;AACvB,WAAO,EAAP;AACD;AAED;;;;;;;AAKAC,EAAAA,cAAc,CAACD,IAAD,EAAO;AACnB,UAAME,MAAM,GAAG,KAAKH,gBAAL,CAAsBC,IAAtB,CAAf;;AAEA,QAAIE,MAAM,KAAK,IAAf,EAAqB;AACnB,aAAO,IAAP;AACD;;AAED,UAAMC,UAAU,GAAGC,MAAM,CAACC,IAAP,CAAYH,MAAZ,CAAnB;AAEA,WAAO,CACL;AACEI,MAAAA,QAAQ,EAAEC,kBAASf,MADrB;AAEEgB,MAAAA,KAAK,EAAE,KAAKb;AAFd,KADK,EAKL;AACEW,MAAAA,QAAQ,EAAEC,kBAASf,MADrB;AAEEgB,MAAAA,KAAK,EAAE,KAAKX;AAFd,KALK,EASL;AACES,MAAAA,QAAQ,EAAEC,kBAASE,MADrB;AAEEC,MAAAA,SAAS,EAAEC,0BAAiBC,KAF9B;AAGEJ,MAAAA,KAAK,EAAEL;AAHT,KATK,EAcL;AACEG,MAAAA,QAAQ,EAAEC,kBAASM,OADrB;AAEEH,MAAAA,SAAS,EAAEC,0BAAiBC,KAF9B;AAGEJ,MAAAA,KAAK,EAAEL,UAAU,CAACW,GAAX,CAAeC,GAAG,IAAIb,MAAM,CAACa,GAAD,CAA5B;AAHT,KAdK,CAAP;AAoBD;AAED;;;;;;;AAKAC,EAAAA,mBAAmB,CAAChB,IAAD,EAAO;AACxB,WAAQ,wBAAuB,KAAKL,QAAS,QAAOK,IAAI,CAACiB,QAAS,EAAlE;AACD;AAED;;;;;;;;;AAOAC,EAAAA,YAAY,CAAClB,IAAD,EAAOmB,YAAP,EAAqB;AAC/B,UAAMD,YAAN,CAAmBlB,IAAnB,EAAyB,CAACoB,GAAD,EAAMC,MAAN,EAAcC,OAAd,KAA0B;AACjD,YAAMC,eAAe,GAAGF,MAAxB;AAEA,YAAMG,WAAW,GAAG,KAAK7B,QAAL,CAAca,KAAd,CAAoBiB,KAApB,CAA0B,4BAA1B,CAApB;;AACA,UAAIJ,MAAM,KAAKK,+BAAYC,gBAAvB,IAA2CH,WAA/C,EAA4D;AAC1DD,QAAAA,eAAe,CAACK,WAAhB,GAA+B,QAAOJ,WAAW,CAAC,CAAD,CAAI;wCAArD;AAED;;AAEDL,MAAAA,YAAY,CAACC,GAAD,EAAMG,eAAN,EAAuBD,OAAvB,CAAZ;AACD,KAVD;AAWD;;AApG4D","sourcesContent":["import { DataType, VariantArrayType } from 'node-opcua/lib/datamodel/variant';\nimport { StatusCodes } from 'node-opcua/lib/datamodel/opcua_status_code';\nimport NodeId from '../../model/opcua/NodeId';\nimport CallMethodStream from './CallMethodStream';\n\n/**\n * A stream that calls atvise server scripts for all passed nodes.\n * @abstract\n */\nexport default class CallScriptStream extends CallMethodStream {\n\n  /**\n   * The id of the *callScript* method.\n   * @type {NodeId}\n   */\n  get methodId() {\n    return new NodeId(NodeId.NodeIdType.STRING, 'AGENT.SCRIPT.METHODS.callScript', 1);\n  }\n\n  /**\n   * **Must be implemented by all subclasses:** The id of the script to call.\n   * @type {NodeId}\n   * @abstract\n   */\n  get scriptId() {\n    throw new Error('Must be implemented by all subclasses');\n  }\n\n  /**\n   * Id of the script's base object.\n   * @type {NodeId}\n   */\n  get scriptBaseId() {\n    return this.scriptId.parent;\n  }\n\n  /**\n   * Returns the parameters to call the script with for the given file.\n   * @param {AtviseFile} file The processed file.\n   * @return {Object} The parameters passed to the script.\n   */\n  scriptParameters(file) { // eslint-disable-line no-unused-vars\n    return {};\n  }\n\n  /**\n   * Creates the raw method input arguments for the given file.\n   * @param {AtviseFile} file The processed file.\n   * @return {?node-opcua~Variant[]} Input arguments for the *callScript* method.\n   */\n  inputArguments(file) {\n    const params = this.scriptParameters(file);\n\n    if (params === null) {\n      return null;\n    }\n\n    const paramNames = Object.keys(params);\n\n    return [\n      {\n        dataType: DataType.NodeId,\n        value: this.scriptId,\n      },\n      {\n        dataType: DataType.NodeId,\n        value: this.scriptBaseId,\n      },\n      {\n        dataType: DataType.String,\n        arrayType: VariantArrayType.Array,\n        value: paramNames,\n      },\n      {\n        dataType: DataType.Variant,\n        arrayType: VariantArrayType.Array,\n        value: paramNames.map(key => params[key]),\n      },\n    ];\n  }\n\n  /**\n   * Returns the error message logged if running the script fails.\n   * @param {AtviseFile} file The processed file.\n   * @return {string} The resulting error message.\n   */\n  processErrorMessage(file) {\n    return `Error running script ${this.scriptId} for ${file.relative}`;\n  }\n\n  /**\n   * Calls the script specified in {@link CallScriptStream#scriptId}. If the script does not exist\n   * but could be imported by running `atscm import` a special status description is returned.\n   * @param {vinyl~File} file The file being processed.\n   * @param {function(err: Error, status: node-opcua~StatusCodes, success: function)} handleErrors\n   * The error handler to call. See {@link QueueStream#processChunk} for details.\n  */\n  processChunk(file, handleErrors) {\n    super.processChunk(file, (err, status, success) => {\n      const processedStatus = status;\n\n      const atscmScript = this.scriptId.value.match(/SERVERSCRIPTS\\.atscm\\.(.*)/);\n      if (status === StatusCodes.BadMethodInvalid && atscmScript) {\n        processedStatus.description = `The '${atscmScript[1]}' script does not exist.\n- Did you forget to run 'atscm import'?`;\n      }\n\n      handleErrors(err, processedStatus, success);\n    });\n  }\n\n}\n"],"file":"CallScriptStream.js"}