{"version":3,"sources":["../../../src/lib/server/NodeBrowser.js"],"names":["HierachicalReferencesTypeIds","Set","ReferenceTypeIds","HasChild","Aggregates","HasComponent","HasOrderedComponent","HasHistoricalConfiguration","HasProperty","HasSubtype","HasEventSource","HasNotifier","Organizes","BrowsedNode","ServerNode","constructor","parent","reference","nodeClass","name","browseName","addReference","toParent","referenceTypeId","value","id","nodeId","addReferences","references","forEach","createChild","options","node","NodeBrowser","concurrency","ignoreNodes","ProjectConfig","handleNode","recursive","queue","PromiseQueue","_handled","Map","_waitingFor","_ignoreNodesRegExp","RegExp","map","n","join","_recursive","_handleNode","_pushed","_readValue","isVariable","Promise","resolve","reject","_session","readVariableValue","err","result","_browse","browseDirection","BrowseDirection","Forward","resultMask","browse","_browseNode","then","allReferences","children","Object","setPrototypeOf","NodeId","prototype","ignored","test","external","_isExternalReference","has","get","undefined","push","Logger","debug","ReferenceTypeNames","_push","error","set","isPaused","addAll","child","_process","idValue","dep","dependencies","add","catch","_reject","addNode","transform","_sourceNodesRegExp","_hasDependencies","dependencyCount","values","concat","_getSourceNodes","nodeIds","browseUp","path","Inverse","unshift","ObjectIds","RootFolder","Error","browseDown","target","all","i","find","ref","pathDown","reduce","replace","Session","create","nodes","processError","pause","clear","onIdle","close","keys","length","unresolved","entries","to","c","from","type","Array","refs","pushed"],"mappings":"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","sourcesContent":["import { ObjectIds } from 'node-opcua/lib/opcua_node_ids.js';\nimport { BrowseDirection } from 'node-opcua/lib/services/browse_service.js';\nimport Logger from 'gulplog';\nimport PromiseQueue from 'p-queue';\nimport ProjectConfig from '../../config/ProjectConfig';\nimport NodeId from '../model/opcua/NodeId';\nimport { ServerNode, ReferenceTypeIds, ReferenceTypeNames } from '../model/Node';\nimport Session from './Session';\n\n/**\n * A set of all hierarchical reference types.\n * @type {Set<number>}\n */\nconst HierachicalReferencesTypeIds = new Set([\n  ReferenceTypeIds.HasChild,\n  ReferenceTypeIds.Aggregates,\n  ReferenceTypeIds.HasComponent,\n  ReferenceTypeIds.HasOrderedComponent,\n  ReferenceTypeIds.HasHistoricalConfiguration,\n  ReferenceTypeIds.HasProperty,\n  ReferenceTypeIds.HasSubtype,\n  ReferenceTypeIds.HasEventSource,\n  ReferenceTypeIds.HasNotifier,\n  ReferenceTypeIds.Organizes,\n]);\n\n/**\n * A node discovered while browsing the server's database.\n */\nexport class BrowsedNode extends ServerNode {\n\n  /**\n   * Creates a new node.\n   * @param {Object} options The options to use.\n   * @param {?BrowsedNode} options.parent The parent node.\n   * @param {Object} options.reference The reference to pick metadata from.\n   */\n  constructor({ parent, reference }) {\n    super({\n      parent,\n      nodeClass: reference.nodeClass,\n      name: reference.browseName.name,\n    });\n\n    this.addReference(ReferenceTypeIds.toParent, reference.referenceTypeId.value);\n\n    /** The node's id. @type {NodeId} */\n    this.id = reference.nodeId;\n  }\n\n  /**\n   * Add multiple references at once.\n   * @param {Object[]} references The references to add.\n   */\n  addReferences(references) {\n    references.forEach(reference => {\n      this.addReference(reference.referenceTypeId.value, reference.nodeId.value);\n    });\n  }\n\n  /**\n   * Creates new child node.\n   * @param {Object} options The options to use.\n   * @see {Node#createChild}\n   */\n  createChild(options) {\n    const node = super.createChild(options);\n\n    node.id = this.id;\n\n    return node;\n  }\n\n}\n\n/**\n * Browses the server database.\n */\nexport default class NodeBrowser {\n\n  /**\n   * Creates a new node browser.\n   * @param {Object} options The options to use.\n   * @param {number} [options.concurrency=250] The maximum of nodes to process in parallel.\n   * @param {function(node: BrowsedNode): Promise<any>} options.handleNode A custom node handler.\n   * @param {boolean} [options.recursive] If the whole node tree should be processed.\n   */\n  constructor({\n    concurrency = 250,\n    ignoreNodes = ProjectConfig.ignoreNodes,\n    handleNode,\n    recursive = true,\n  } = {}) {\n    this.queue = new PromiseQueue({\n      // autoStart: false,\n      concurrency,\n    });\n\n    /** A map of nodes already handled. Keys are ids, values are `true` if the node was already\n     * pushed and `false` otherwise.\n     * @type {Map<string, boolean>}\n     * */\n    this._handled = new Map();\n\n    this._waitingFor = {};\n\n    /** A regular expression matching all ignored nodes. @type {RegExp} */\n    this._ignoreNodesRegExp = new RegExp(`^(${ignoreNodes\n      .map(n => n.value)\n      .join('|')})`);\n\n    /** If the browser should recurse. @type {boolean} */\n    this._recursive = recursive;\n\n    /** The custom node handler. @type {function(node: BrowsedNode): Promise<any>} */\n    this._handleNode = handleNode;\n\n    /** The number of pushed (discovered and handled) nodes. @type {number} */\n    this._pushed = 0;\n  }\n\n  /**\n   * Reads the given node's value.\n   * @param {BrowsedNode} node The node to read.\n   */\n  _readValue(node) {\n    if (!node.isVariable) { return null; }\n    return new Promise((resolve, reject) => {\n      this._session.readVariableValue(node.id, (err, result) => {\n        if (err) { return reject(err); }\n        return resolve(result && result.value);\n      });\n    });\n  }\n\n  // FIXME: Debounce á la https://runkit.com/5c347d277da2ad00125b6bc2/5c50161cbc21520012c42290\n  // FIXME: Move to api\n  /**\n   * Browses the server address space at the given node id.\n   * @param {Object} options The options to use.\n   */\n  _browse({ nodeId, browseDirection = BrowseDirection.Forward, resultMask = 63 }) {\n    return new Promise((resolve, reject) => {\n      this._session.browse({ nodeId, browseDirection, resultMask },\n        (err, [{ references }] = []) => (err ? reject(err) : resolve(references)));\n    });\n  }\n\n  /**\n   * Browses a node.\n   * @param {BrowsedNode} node The node to browse.\n   */\n  _browseNode(node) {\n    return this._browse({ nodeId: node.id })\n      .then(allReferences => {\n        const children = [];\n        const references = [];\n\n        allReferences.forEach(reference => {\n          // \"Cast\" ref.nodeId to NodeId\n          Object.setPrototypeOf(reference.nodeId, NodeId.prototype);\n\n          const ignored = this._ignoreNodesRegExp.test(reference.nodeId.value);\n          const external = this._isExternalReference(reference.nodeId.value);\n\n          if (\n            HierachicalReferencesTypeIds.has(reference.referenceTypeId.value) &&\n            !ignored &&\n            !external\n          ) {\n            if (this._handled.get(reference.nodeId.value) === undefined) {\n              children.push(new BrowsedNode({\n                parent: node,\n                reference,\n              }));\n            } // else node is already handled\n          } else if (reference.referenceTypeId.value !== 50) { // Added by atvise builder\n            // Do not add ignored\n            if (!ignored) {\n              references.push(reference);\n            } else {\n              Logger.debug(`Ignored reference from ${node.id.value} (${\n                ReferenceTypeNames[reference.referenceTypeId.value]\n              }) to ${reference.nodeId.value}`);\n            }\n          }\n        });\n\n        // eslint-disable-next-line no-param-reassign\n        node.children = children;\n        node.addReferences(references);\n\n        return { children, references };\n      });\n  }\n\n  /**\n   * Finishes processing a given node: After calling {@link NodeBrowser#_handleNode}, it resolves\n   * is's dependencies.\n   * @param {BrowsedNode} node The node handled.\n   */\n  async _push(node) {\n    if (this._handled.get(node.id.value)) {\n      Logger.error('Prevented duplicate handling of', node.id.value);\n      return;\n    }\n\n    // Prevent duplicate pushes while reading value file\n    this._handled.set(node.id.value, 'processing');\n\n    // eslint-disable-next-line no-param-reassign\n    node.value = (await this._readValue(node) || node.value);\n\n    // TODO: Remove additional properties (children, ...) for better memory-usage\n\n    await this._handleNode(node);\n\n    this._pushed += 1;\n\n    // Do not proceed if queue is stopped (because an error occured)\n    if (!this._recursive || this.queue.isPaused) {\n      // Queue is stopped, not adding...\n      return;\n    }\n\n    this.queue.addAll(node.children.map(child => () => this._process(child)));\n\n    const idValue = node.id.value;\n    this._handled.set(idValue, true);\n\n    // Handle dependencies\n    if (this._waitingFor[idValue]) {\n      this._waitingFor[idValue].forEach(dep => {\n        // eslint-disable-next-line no-param-reassign\n        if (--dep.dependencies === 0) {\n          // Adding as dependencies are resolved\n          this.queue.add(() => this._push(dep)).catch(this._reject);\n        }\n      });\n\n      delete this._waitingFor[idValue];\n    }\n  }\n\n  /**\n   * Instructs the browser to handle a node that would otherwise be queued behind others (eg: its\n   * parent node).\n   * @param {BrowsedNode} node The node to add.\n   * @return {Promise<?BrowsedNode>} The fully processed node.\n   */\n  addNode(node) {\n    if (this.queue.isPaused) {\n      Logger.debug('Queue is stopped, not adding...');\n      return Promise.resolve();\n    }\n\n    return this.queue.add(\n      () => this._handleNode(node, { transform: false })\n    )\n      .catch(this._reject);\n  }\n\n  /**\n   * Returns `true` for node ids that should be treated as external references.\n   * @param {string|number} idValue Value of the id to check.\n   * @return {boolean} If the id should be treated as external.\n   */\n  _isExternalReference(idValue) { // FIXME: Allow plugins\n    return typeof idValue !== 'string' || !this._sourceNodesRegExp.test(idValue);\n  }\n\n  /**\n   * Returns `true` if a node has dependencies it should be queued behind.\n   * @param {BrowsedNode} node The node to check.\n   */\n  _hasDependencies(node) {\n    let dependencyCount = 0;\n\n    for (const references of node.references.values()) {\n      for (const reference of references) {\n        if (\n          // !this._handled.get(reference) &&\n          !this._isExternalReference(reference) &&\n          !this._ignoreNodesRegExp.test(reference)\n        ) {\n          dependencyCount++;\n          this._waitingFor[reference] = (this._waitingFor[reference] || []).concat(node);\n        }\n      }\n    }\n\n    // eslint-disable-next-line no-param-reassign\n    node.dependencies = dependencyCount;\n\n    return dependencyCount > 0;\n  }\n\n  /**\n   * Processes a single node: Requires special error handling.\n   * @param {BrowsedNode} node The node to process.\n   * @return {Promise<?BrowsedNode>} The fully processed node.\n   */\n  async _process(node) {\n    try {\n      if (this._handled.has(node.id.value)) { // Already queued\n        return undefined;\n      }\n      this._handled.set(node.id.value, false);\n      await this._browseNode(node);\n\n      if (!this._hasDependencies(node)) {\n        await this._push(node);\n      }\n    } catch (err) {\n      this._reject(err);\n    }\n\n    return node;\n  }\n\n  /**\n   * Discovers and browses the source nodes.\n   * @param {Array<string, NodeId>} nodeIds The source ids.\n   * @return {Promise<Node[]>} Resolved once finished.\n   */\n  _getSourceNodes(nodeIds) {\n    const browseUp = ({ nodeId, path = [] }) => this._browse({\n      nodeId,\n      browseDirection: BrowseDirection.Inverse,\n    })\n      .then(references => {\n        for (const reference of references) {\n          if (HierachicalReferencesTypeIds.has(reference.referenceTypeId.value)) {\n            path.unshift(reference.nodeId);\n            return reference.nodeId.value === ObjectIds.RootFolder ?\n              path :\n              browseUp({ nodeId: reference.nodeId, path });\n          }\n        }\n        throw new Error(`Unable to find parent node of ${nodeId}`);\n      });\n\n    const browseDown = (path, target) => Promise.all(path\n      .map((nodeId, i) => this._browse({ nodeId })\n        .then(references => references\n          .find(ref => ref.nodeId.value === (\n            path[i + 1] ? path[i + 1].value : target.value\n          ))\n        )\n      )\n    );\n\n    return Promise.all(nodeIds\n      .map(nodeId => browseUp({ nodeId })\n        .then(path => browseDown(path, nodeId))\n        .then(pathDown => pathDown\n          .reduce((parent, reference) => new BrowsedNode({ parent, reference }), null)\n        )\n      )\n    );\n  }\n\n  /**\n   * Starts the browser of the given nodes.\n   * @param {NodeId[]} nodeIds The nodes to browse.\n   * @return {Promise<any>} Resolved once all nodes are finished.\n   */\n  async browse(nodeIds) {\n    this._sourceNodesRegExp = new RegExp(`^(${nodeIds\n      .map(({ value }) => `${value.replace(/\\./g, '\\\\.')}`)\n      .join('|')})`);\n\n    this._session = await Session.create();\n\n    // Add source nodes\n    const nodes = await this._getSourceNodes(nodeIds);\n    this.queue.addAll(nodes.map(node => () => this._process(node)));\n\n    // Queue error handling\n    let processError = null;\n    this._reject = err => {\n      if (processError) {\n        // Multiple errors occured. In most cases this means, that the server connection was closed\n        // after the first error.\n        Logger.debug('Additional error', err);\n        return;\n      }\n\n      processError = err;\n      this.queue.pause();\n      this.queue.clear();\n    };\n\n    return new Promise((resolve, reject) => {\n      this.queue.onIdle()\n        .then(async () => {\n          await Session.close(this._session);\n\n          if (processError) {\n            reject(processError);\n            return;\n          }\n\n          if (Object.keys(this._waitingFor).length) {\n            const unresolved = Object.entries(this._waitingFor)\n              .reduce((all, [to, children]) => all.concat(children\n                .map(c => ({\n                  from: c.id.value,\n                  to,\n                  type: ReferenceTypeNames[\n                    Array.from(c.references).find(([, refs]) => refs.has(to))[0]\n                  ],\n                }))\n              ), []);\n\n            reject(new Error(`Unable to resolve reference${unresolved.length > 1 ? 's' : ''}:\n\n  ${\n  unresolved\n    .map(({ from, type, to }) => `${from} → (${type}) → ${to}`)\n    .join('\\n  ')\n}\n`));\n            return;\n          }\n\n          if (Array.from(this._handled).find(([, pushed]) => !pushed)) {\n            throw new Error('A node was processed, but not pushed');\n          }\n\n          resolve();\n        });\n    });\n  }\n\n}\n"],"file":"NodeBrowser.js"}