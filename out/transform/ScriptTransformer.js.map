{"version":3,"sources":["../../src/transform/ScriptTransformer.js"],"names":["ScriptTransformer","shouldBeTransformed","file","isScript","isQuickDynamic","transformFromDB","enc","callback","decodeContents","err","results","document","warn","relative","config","metaTag","elements","forEach","child","type","name","icon","Object","assign","content","attributes","visible","Boolean","parseInt","title","description","metadata","value","Array","isArray","push","includes","debug","paramTags","length","parameters","param","target","index","map","tagName","parsedIndex","namespaceIndex","isNaN","codeNode","code","configFile","splitFile","contents","Buffer","from","JSON","stringify","scriptFile","createCombinedFile","files","lastFile","parse","toString","e","Error","message","result","meta","undefined","entries","v","targetElements","script","combineFiles","keys","ext","encodeContents","encodeErr","xmlString"],"mappings":"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","file":"ScriptTransformer.js","sourcesContent":["import Logger from 'gulplog';\nimport XMLTransformer from '../lib/transform/XMLTransformer';\nimport {\n  findChild, findChildren,\n  textContent,\n  createElement, createTextNode, createCDataNode,\n} from '../lib/helpers/xml';\n\n/**\n * A transformer that splits atvise scripts and quick dynamics into a code file and a .json file\n * containing parameters and metadata.\n */\nexport default class ScriptTransformer extends XMLTransformer {\n\n  /**\n   * Returns `true` for all files containing script code or quick dynamics.\n   * @param {AtviseFile} file The file to check.\n   * @return {boolean} `true` for all files containing script code or quick dynamics.\n   */\n  shouldBeTransformed(file) {\n    return file.isScript || file.isQuickDynamic;\n  }\n\n  /**\n   * Splits any read files containing scripts or quick dynamics into their JavaScript sources,\n   * alongside with a json file containing parameters and metadata.\n   * @param {AtviseFile} file The script file to split.\n   * @param {string} enc The encoding used.\n   * @param {function(err: Error, file: AtviseFile)} callback Called with the error that occured\n   * while transforming the script, or the file passed through.\n   */\n  transformFromDB(file, enc, callback) {\n    this.decodeContents(file, (err, results) => {\n      if (err) {\n        callback(err);\n      } else {\n        const document = results && findChild(results, 'script');\n\n        if (!document) {\n          Logger.warn(`Empty document at ${file.relative}`);\n        }\n\n        const config = {};\n\n        // Extract metadata\n        const metaTag = findChild(document, 'metadata');\n        if (metaTag && metaTag.elements) {\n          // TODO: Warn on multiple metadata tags\n          metaTag.elements.forEach(child => {\n            if (child.type === 'element') {\n              if (child.name === 'icon') { // - Icon\n                config.icon = Object.assign({\n                  content: textContent(child) || '',\n                }, child.attributes);\n              } else if (child.name === 'visible') { // - Visible\n                config.visible = Boolean(parseInt(textContent(child), 10));\n              } else if (child.name === 'title') {\n                config.title = textContent(child);\n              } else if (child.name === 'description') {\n                config.description = textContent(child);\n              } else {\n                if (!config.metadata) {\n                  config.metadata = {};\n                }\n\n                const value = textContent(child);\n\n                if (config.metadata[child.name]) {\n                  if (!Array.isArray(config.metadata[child.name])) {\n                    config.metadata[child.name] = [config.metadata[child.name]];\n                  }\n\n                  config.metadata[child.name].push(value);\n                } else {\n                  config.metadata[child.name] = textContent(child);\n                }\n\n                if (![\n                  'longrunning',\n                ].includes(child.name)) {\n                  Logger.debug(`Generic metadata element '${child.name}' at ${file.relative}`);\n                }\n              }\n            }\n          });\n        }\n\n        // Extract Parameters\n        const paramTags = findChildren(document, 'parameter');\n        if (paramTags.length) {\n          config.parameters = [];\n          paramTags.forEach(({ attributes, elements }) => {\n            const param = Object.assign({}, attributes);\n\n            // Handle relative parameter targets\n            if (attributes.relative === 'true') {\n              param.target = {};\n\n              const target = findChild(elements[0],\n                ['Elements', 'RelativePathElement', 'TargetName']);\n\n              if (target) {\n                const [index, name] = ['NamespaceIndex', 'Name']\n                  .map(tagName => textContent(findChild(target, tagName)));\n\n                const parsedIndex = parseInt(index, 10);\n\n                param.target = { namespaceIndex: isNaN(parsedIndex) ? 1 : parsedIndex, name };\n              }\n            }\n\n            config.parameters.push(param);\n          });\n        }\n\n        // Extract JavaScript\n        const codeNode = findChild(document, 'code');\n        const code = textContent(codeNode) || '';\n\n        // Write config file\n        const configFile = ScriptTransformer.splitFile(file, '.json');\n        configFile.contents = Buffer.from(JSON.stringify(config, null, '  '));\n        this.push(configFile);\n\n        // Write script file\n        const scriptFile = ScriptTransformer.splitFile(file, '.js');\n        scriptFile.contents = Buffer.from(code);\n        this.push(scriptFile);\n\n        callback(null);\n      }\n    });\n  }\n\n  /**\n   * Creates a script from the collected files.\n   * @param {Map<String, AtviseFile>} files The collected files, stored against their extension.\n   * @param {AtviseFile} lastFile The last file read. *Used for error messages only*.\n   * @param {function(err: ?Error, data: vinyl~File)} callback Called with the error that occured\n   * while creating the script or the resulting file.\n   */\n  createCombinedFile(files, lastFile, callback) {\n    const configFile = files['.json'];\n    let config = {};\n\n    if (configFile) {\n      try {\n        config = JSON.parse(configFile.contents.toString());\n      } catch (e) {\n        callback(new Error(`Error parsing JSON in ${configFile.relative}: ${e.message}`));\n        return;\n      }\n    }\n\n    const scriptFile = files['.js'];\n    let code = '';\n\n    if (scriptFile) {\n      code = scriptFile.contents.toString();\n    }\n\n    const document = createElement('script', []);\n\n    const result = {\n      elements: [\n        document,\n      ],\n    };\n\n    // Insert metadata\n    const meta = [];\n\n    if (lastFile.isQuickDynamic) {\n      // - Icon\n      if (config.icon) {\n        const icon = config.icon.content;\n        delete config.icon.content;\n\n        meta.push(createElement('icon', [createTextNode(icon)], config.icon));\n      }\n\n      // - Other fields\n      if (config.visible !== undefined) {\n        meta.push(createElement('visible', [createTextNode(`${config.visible ? 1 : 0}`)]));\n      }\n\n      if (config.title !== undefined) {\n        meta.push(createElement('title', [createTextNode(config.title)]));\n      }\n\n      if (config.description !== undefined) {\n        meta.push(createElement('description', [createTextNode(config.description)]));\n      }\n    }\n\n    // - Additional fields\n    if (config.metadata !== undefined) {\n      Object.entries(config.metadata)\n        .forEach(([name, value]) => {\n          (Array.isArray(value) ? value : [value])\n            .forEach(v => meta.push(createElement(name, [createTextNode(v)])));\n        });\n    }\n\n    if (lastFile.isQuickDynamic || meta.length) {\n      document.elements.push(createElement('metadata', meta));\n    }\n\n    // Insert parameters\n    if (config.parameters) {\n      config.parameters.forEach(attributes => {\n        let elements;\n\n        // Handle relative parameter targets\n        if (attributes.relative === 'true' && attributes.target) {\n          const { namespaceIndex, name } = attributes.target;\n          const targetElements = createElement('Elements');\n\n          elements = [createElement('RelativePath', [targetElements])];\n\n          if (name !== undefined) {\n            targetElements.elements = [\n              createElement('RelativePathElement', [\n                createElement('TargetName', [\n                  createElement('NamespaceIndex', [createTextNode(`${namespaceIndex}`)]),\n                  createElement('Name', [createTextNode(`${name}`)]),\n                ]),\n              ]),\n            ];\n          }\n\n          // eslint-disable-next-line no-param-reassign\n          delete attributes.target;\n        }\n\n        document.elements.push(createElement('parameter', elements, attributes));\n      });\n    }\n\n    // Insert script code\n    document.elements.push(createElement('code', [createCDataNode(code)]));\n\n    const script = ScriptTransformer.combineFiles(\n      Object.keys(files).map(ext => files[ext]),\n      '.xml'\n    );\n\n    this.encodeContents(result, (encodeErr, xmlString) => {\n      if (encodeErr) {\n        callback(encodeErr);\n      } else {\n        script.contents = Buffer.from(xmlString);\n\n        callback(null, script);\n      }\n    });\n  }\n\n}\n"]}