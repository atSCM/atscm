{"version":3,"sources":["../../src/transform/ScriptTransformer.js"],"names":["AtviseScriptTransformer","XMLTransformer","sourceExtensions","processMetadata","document","config","metaTag","childNodes","forEach","child","type","name","icon","Object","assign","content","attributes","visible","Boolean","parseInt","title","description","metadata","value","Array","isArray","push","includes","Logger","debug","processParameters","paramTags","length","undefined","map","param","relative","target","find","isElement","index","tagName","parsedIndex","namespaceIndex","isNaN","transformFromDB","node","context","shouldBeTransformed","arrayType","VariantArrayType","Scalar","Error","xml","decodeContents","nodeId","parameters","configFile","constructor","splitFile","dataType","DataType","String","JSON","stringify","addNode","codeNode","scriptFile","combineNodes","sources","parse","stringValue","e","message","code","result","meta","isQuickDynamic","entries","v","elements","targetElements","encodeContents","ServerscriptTransformer","extension","isVariable","isScript","QuickDynamicTransformer"],"mappings":"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","sourcesContent":["import Logger from 'gulplog';\nimport { DataType, VariantArrayType } from 'node-opcua/lib/datamodel/variant';\nimport {\n  findChild, findChildren, textContent, createElement, createTextNode, createCDataNode,\n  prependChild, appendChild, isElement,\n} from 'modify-xml';\nimport XMLTransformer from '../lib/transform/XMLTransformer';\n\n/**\n * A transformer that splits atvise scripts and quick dynamics into a code file and a .json file\n * containing parameters and metadata.\n */\nexport class AtviseScriptTransformer extends XMLTransformer {\n\n  /**\n   * The source file extensions to allow.\n   * @type {string[]}\n   */\n  static get sourceExtensions() {\n    return ['.json', '.js'];\n  }\n\n  /**\n   * Extracts a script's metadata.\n   * @param {Object} document The parsed xml document to process.\n   * @return {Object} The metadata found.\n   */\n  processMetadata(document) {\n    const config = {};\n\n    const metaTag = findChild(document, 'metadata');\n    // console.error('Meta', metaTag);\n    if (!metaTag || !metaTag.childNodes) { return config; }\n\n    metaTag.childNodes.forEach(child => {\n      if (child.type !== 'element') { return; }\n\n      switch (child.name) {\n        case 'icon':\n          config.icon = Object.assign({\n            content: textContent(child) || '',\n          }, child.attributes);\n          break;\n        case 'visible':\n          config.visible = Boolean(parseInt(textContent(child), 10));\n          break;\n        case 'title':\n          config.title = textContent(child);\n          break;\n        case 'description':\n          config.description = textContent(child);\n          break;\n        default: {\n          if (!config.metadata) { config.metadata = {}; }\n\n          const value = textContent(child);\n\n          if (config.metadata[child.name]) {\n            if (!Array.isArray(config.metadata[child.name])) {\n              config.metadata[child.name] = [config.metadata[child.name]];\n            }\n\n            config.metadata[child.name].push(value);\n          } else {\n            config.metadata[child.name] = textContent(child);\n          }\n\n          if (![\n            'longrunning',\n          ].includes(child.name)) {\n            Logger.debug(`Generic metadata element '${child.name}'`); // FIXME:  at ${node.nodeId}\n          }\n          break;\n        }\n      }\n    });\n\n    return config;\n  }\n\n  /**\n   * Extracts a script's parameters.\n   * @param {Object} document The parsed xml document to process.\n   * @return {Object[]} The parameters found.\n   */\n  processParameters(document) {\n    const paramTags = findChildren(document, 'parameter');\n    if (!paramTags.length) { return undefined; }\n\n    return paramTags.map(({ attributes, childNodes }) => {\n      const param = Object.assign({}, attributes);\n\n      // Handle relative parameter targets\n      if (attributes.relative === 'true') {\n        param.target = {};\n\n        const target = findChild(childNodes.find(isElement),\n          ['Elements', 'RelativePathElement', 'TargetName']);\n\n        if (target) {\n          const [index, name] = ['NamespaceIndex', 'Name']\n            .map(tagName => textContent(findChild(target, tagName)));\n\n          const parsedIndex = parseInt(index, 10);\n\n          param.target = { namespaceIndex: isNaN(parsedIndex) ? 1 : parsedIndex, name };\n        }\n      }\n\n      return param;\n    });\n  }\n\n  /**\n   * Splits a node into multiple source nodes.\n   * @param {Node} node A server node.\n   * @param {Object} context The current transform context.\n   */\n  async transformFromDB(node, context) {\n    if (!this.shouldBeTransformed(node)) { return undefined; }\n\n    if (node.arrayType !== VariantArrayType.Scalar) {\n      // FIXME: Instead of throwing we could simply pass the original node to the callback\n      throw new Error('Array of scripts not supported');\n    }\n\n    const xml = this.decodeContents(node);\n    if (!xml) { throw new Error('Error parsing script'); }\n\n    const document = findChild(xml, 'script');\n    if (!document) {\n      throw new Error(`Empty document at ${node.nodeId}`);\n    }\n\n    // Extract metadata and parameters\n    const config = {\n      ...this.processMetadata(document),\n      parameters: this.processParameters(document),\n    };\n\n    // Write config file\n    const configFile = this.constructor.splitFile(node, '.json');\n    configFile.value = {\n      dataType: DataType.String,\n      arrayType: VariantArrayType.Scalar,\n      value: JSON.stringify(config, null, '  '),\n    };\n    context.addNode(configFile);\n\n    // Write JavaScript file\n    const codeNode = findChild(document, 'code');\n    const scriptFile = this.constructor.splitFile(node, '.js');\n    scriptFile.value = {\n      dataType: DataType.String,\n      arrayType: VariantArrayType.Scalar,\n      value: textContent(codeNode) || '',\n    };\n    context.addNode(scriptFile);\n\n    return super.transformFromDB(node);\n  }\n\n  /**\n   * Inlines the passed source nodes to the given container node.\n   * @param {Node} node The container node.\n   * @param {{ [ext: string]: Node }} sources The source nodes to inline.\n   */\n  combineNodes(node, sources) {\n    const configFile = sources['.json'];\n    let config = {};\n\n    if (configFile) {\n      try {\n        config = JSON.parse(configFile.stringValue);\n      } catch (e) {\n        throw new Error(`Error parsing JSON in ${configFile.relative}: ${e.message}`);\n      }\n    }\n\n    const scriptFile = sources['.js'];\n    let code = '';\n\n    if (scriptFile) {\n      code = scriptFile.stringValue;\n    }\n\n    const document = createElement('script', []);\n\n    const result = {\n      childNodes: [\n        { type: 'directive', value: '<?xml version=\"1.0\" encoding=\"UTF-8\"?>' },\n        document,\n      ],\n    };\n\n    // Insert metadata\n    const meta = [];\n\n    if (node.isQuickDynamic) {\n      // - Icon\n      if (config.icon) {\n        const icon = config.icon.content;\n        delete config.icon.content;\n\n        meta.push(createElement('icon', [createTextNode(icon)], config.icon));\n      }\n\n      // - Other fields\n      if (config.visible !== undefined) {\n        meta.push(createElement('visible', [createTextNode(`${config.visible ? 1 : 0}`)]));\n      }\n\n      if (config.title !== undefined) {\n        meta.push(createElement('title', [createTextNode(config.title)]));\n      }\n\n      if (config.description !== undefined) {\n        meta.push(createElement('description', [createTextNode(config.description)]));\n      }\n    }\n\n    // - Additional fields\n    if (config.metadata !== undefined) {\n      Object.entries(config.metadata)\n        .forEach(([name, value]) => {\n          (Array.isArray(value) ? value : [value])\n            .forEach(v => meta.push(createElement(name, [createTextNode(v)])));\n        });\n    }\n\n    if (node.isQuickDynamic || meta.length) {\n      prependChild(document, createElement('metadata', meta));\n    }\n\n    // Insert parameters\n    if (config.parameters) {\n      config.parameters.forEach(attributes => {\n        let elements;\n\n        // Handle relative parameter targets\n        if (attributes.relative === 'true' && attributes.target) {\n          const { namespaceIndex, name } = attributes.target;\n          const targetElements = createElement('Elements');\n\n          elements = [createElement('RelativePath', [targetElements])];\n\n          if (name !== undefined) {\n            targetElements.childNodes = [\n              createElement('RelativePathElement', [\n                createElement('TargetName', [\n                  createElement('NamespaceIndex', [createTextNode(`${namespaceIndex}`)]),\n                  createElement('Name', [createTextNode(`${name}`)]),\n                ]),\n              ]),\n            ];\n          }\n\n          // eslint-disable-next-line no-param-reassign\n          delete attributes.target;\n        }\n\n        appendChild(document, createElement('parameter', elements, attributes));\n      });\n    }\n\n    // Insert script code\n    appendChild(document, createElement('code', [createCDataNode(code)]));\n\n    // eslint-disable-next-line no-param-reassign\n    node.value.value = this.encodeContents(result);\n  }\n\n}\n\n/**\n * A transformer that splits atvise server scripts into multiple files.\n */\nexport class ServerscriptTransformer extends AtviseScriptTransformer {\n\n  /** The container's extension. */\n  static get extension() {\n    return '.script';\n  }\n\n  /**\n   * Returns `true` for all script nodes.\n   * @param {Node} node The node to check.\n   * @return {boolean} If the node is a server script.\n   */\n  shouldBeTransformed(node) {\n    return node.isVariable && node.isScript;\n  }\n\n}\n\n/**\n * A transformer that splits atvise quickdynamics into multiple files.\n */\nexport class QuickDynamicTransformer extends AtviseScriptTransformer {\n\n  /** The container's extension. */\n  static get extension() {\n    return '.qd';\n  }\n\n  /**\n   * Returns `true` for all nodes containing quick dynamics.\n   * @param {Node} node The node to check.\n   * @return {boolean} If the node is a quick dynamic.\n   */\n  shouldBeTransformed(node) {\n    return node.isVariable && node.isQuickDynamic;\n  }\n\n}\n"],"file":"ScriptTransformer.js"}