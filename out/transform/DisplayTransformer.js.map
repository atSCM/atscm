{"version":3,"sources":["../../src/transform/DisplayTransformer.js"],"names":["rootMetaTags","tag","key","DisplayTransformer","XMLTransformer","extension","scriptSourceExtension","sourceExtensions","shouldBeTransformed","node","hasTypeDefinition","transformFromDB","context","undefined","arrayType","VariantArrayType","Scalar","Error","xml","decodeContents","document","config","scriptTags","inlineScript","length","forEach","script","attributes","src","dependencies","push","Logger","id","value","startsWith","childNodes","scriptFile","constructor","splitFile","scriptText","dataType","DataType","String","addNode","element","additional","warn","nodeId","metaTag","paramTags","parameters","n","configFile","JSON","stringify","svgFile","encodeContents","combineNodes","sources","parse","stringValue","e","relative","message","result","svg","s","type","i","reverse"],"mappings":"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","sourcesContent":["import { DataType, VariantArrayType } from 'node-opcua/lib/datamodel/variant';\nimport Logger from 'gulplog';\nimport {\n  findChild,\n  removeChildren,\n  createCDataNode,\n  createElement,\n  appendChild,\n  prependChild,\n  textContent,\n  createTextNode,\n  attributeValues,\n} from 'modify-xml';\nimport XMLTransformer from '../lib/transform/XMLTransformer';\n\nconst rootMetaTags = [{ tag: 'title' }, { tag: 'desc', key: 'description' }];\n\n/**\n * Splits read atvise display XML nodes into their SVG and JavaScript sources,\n * alongside with a .json file containing the display's parameters.\n */\nexport default class DisplayTransformer extends XMLTransformer {\n  /**\n   * The extension to add to display container node names when they are pulled.\n   * @type {string}\n   */\n  static get extension() {\n    return '.display';\n  }\n\n  /**\n   * The source file extension to allow for scripts.\n   */\n  static get scriptSourceExtension() {\n    return '.js';\n  }\n\n  /**\n   * The source file extensions to allow.\n   * @type {string[]}\n   */\n  static get sourceExtensions() {\n    return ['.json', '.svg', this.scriptSourceExtension];\n  }\n\n  /**\n   * Returns `true` for all display nodes.\n   * @param {Node} node The node to check.\n   */\n  shouldBeTransformed(node) {\n    return node.hasTypeDefinition('VariableTypes.ATVISE.Display');\n  }\n\n  /**\n   * Splits any read files containing atvise displays into their SVG and JavaScript sources,\n   * alongside with a json file containing the display's parameters.\n   * @param {BrowsedNode} node The node to split.\n   * @param {Object} context The transform context.\n   */\n  async transformFromDB(node, context) {\n    if (!this.shouldBeTransformed(node)) {\n      return undefined;\n    }\n\n    if (node.arrayType !== VariantArrayType.Scalar) {\n      // FIXME: Instead of throwing we could simply pass the original node to the callback\n      throw new Error('Array of displays not supported');\n    }\n\n    const xml = this.decodeContents(node);\n    if (!xml) {\n      throw new Error('Error parsing display');\n    }\n\n    const document = findChild(xml, 'svg');\n    if (!document) {\n      throw new Error('Error parsing display: No `svg` tag');\n    }\n\n    const config = {};\n    const scriptTags = removeChildren(document, 'script');\n    let inlineScript;\n\n    // Extract JavaScript\n    if (scriptTags.length) {\n      scriptTags.forEach(script => {\n        const attributes = attributeValues(script);\n        if (attributes && (attributes.src || attributes['xlink:href'])) {\n          if (!config.dependencies) {\n            config.dependencies = [];\n          }\n\n          config.dependencies.push(attributes.src || attributes['xlink:href']);\n        } else {\n          // Warn on multiple inline scripts\n          if (inlineScript) {\n            Logger[node.id.value.startsWith('SYSTEM.LIBRARY.ATVISE') ? 'debug' : 'warn'](\n              `'${node.id.value}' contains multiple inline scripts.`\n            );\n            document.childNodes.push(inlineScript);\n          }\n          inlineScript = script;\n        }\n      });\n    }\n    if (inlineScript) {\n      const scriptFile = this.constructor.splitFile(node, '.js');\n      const scriptText = textContent(inlineScript);\n\n      scriptFile.value = {\n        dataType: DataType.String,\n        arrayType: VariantArrayType.Scalar,\n        value: scriptText,\n      };\n      context.addNode(scriptFile);\n    }\n\n    rootMetaTags.forEach(({ tag, key }) => {\n      const [element, ...additional] = removeChildren(document, tag);\n      if (!element) return;\n\n      config[key || tag] = textContent(element);\n\n      if (additional.length) {\n        Logger.warn(`Removed additional <${tag} /> element inside ${node.nodeId}`);\n      }\n    });\n\n    // Extract metadata\n    const metaTag = findChild(document, 'metadata');\n    if (metaTag && metaTag.childNodes) {\n      // TODO: Warn on multiple metadata tags\n\n      // - Parameters\n      const paramTags = removeChildren(metaTag, 'atv:parameter');\n      if (paramTags.length) {\n        config.parameters = [];\n\n        paramTags.forEach(n => config.parameters.push(attributeValues(n)));\n      }\n    }\n\n    const configFile = this.constructor.splitFile(node, '.json');\n    configFile.value = {\n      dataType: DataType.String,\n      arrayType: VariantArrayType.Scalar,\n      value: JSON.stringify(config, null, '  '),\n    };\n    context.addNode(configFile);\n\n    const svgFile = this.constructor.splitFile(node, '.svg');\n    svgFile.value = {\n      dataType: DataType.String,\n      arrayType: VariantArrayType.Scalar,\n      value: this.encodeContents(xml),\n    };\n    context.addNode(svgFile);\n\n    // equals: node.renameTo(`${node.name}.display`);\n    return super.transformFromDB(node);\n  }\n\n  /**\n   * Creates a display from the collected nodes.\n   * @param {BrowsedNode} node The container node.\n   * @param {Map<string, BrowsedNode>} sources The collected files, stored against their\n   * extension.\n   */\n  combineNodes(node, sources) {\n    const configFile = sources['.json'];\n    let config = {};\n\n    if (configFile) {\n      try {\n        config = JSON.parse(configFile.stringValue);\n      } catch (e) {\n        throw new Error(`Error parsing JSON in ${configFile.relative}: ${e.message}`);\n      }\n    }\n\n    const svgFile = sources['.svg'];\n    if (!svgFile) {\n      throw new Error(`No display SVG for ${node.nodeId}`);\n    }\n\n    const scriptFile = sources[this.constructor.scriptSourceExtension];\n    let inlineScript = '';\n    if (scriptFile) {\n      inlineScript = scriptFile.stringValue;\n    }\n\n    const xml = this.decodeContents(svgFile);\n    const result = xml;\n    const svg = findChild(result, 'svg');\n\n    if (!svg) {\n      throw new Error('Error parsing display SVG: No `svg` tag');\n    }\n\n    // Insert dependencies\n    if (config.dependencies) {\n      config.dependencies.forEach(s => {\n        appendChild(svg, createElement('script', undefined, { 'xlink:href': s }));\n      });\n    }\n\n    // Insert script\n    // FIXME: Import order is not preserved!\n    if (scriptFile) {\n      appendChild(\n        svg,\n        createElement('script', [createCDataNode(inlineScript)], {\n          type: 'text/ecmascript',\n        })\n      );\n    }\n\n    // Insert metadata\n    // - Parameters\n    if (config.parameters && config.parameters.length > 0) {\n      let [metaTag] = removeChildren(svg, 'metadata');\n\n      // FIXME: Warn on multiple metadata tags\n\n      if (!metaTag) {\n        metaTag = createElement('metadata');\n      }\n\n      // Parameters should come before other atv attributes, e.g. `atv:gridconfig`\n      for (let i = config.parameters.length - 1; i >= 0; i--) {\n        prependChild(metaTag, createElement('atv:parameter', undefined, config.parameters[i]));\n      }\n\n      // Insert <metadata> as first element in the resulting svg, after <defs>, <desc> and\n      // <title> if defined (nothing to do, they are ordered inside #encodeContents)\n      prependChild(svg, metaTag);\n    }\n\n    // - Title and description\n    rootMetaTags.reverse().forEach(({ tag, key }) => {\n      const value = config[key || tag];\n\n      if (value !== undefined) {\n        prependChild(svg, createElement(tag, [createTextNode(value)]));\n      }\n    });\n\n    // eslint-disable-next-line\n    node.value.value = this.encodeContents(result);\n    return node;\n  }\n}\n"],"file":"DisplayTransformer.js"}