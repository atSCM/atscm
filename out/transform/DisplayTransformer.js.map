{"version":3,"sources":["../../src/transform/DisplayTransformer.js"],"names":["tagsBeforeMetadata","Set","metadataIndex","elements","index","length","has","name","DisplayTransformer","XMLTransformer","extension","sourceExtensions","shouldBeTransformed","node","hasTypeDefinition","transformFromDB","context","undefined","arrayType","VariantArrayType","Scalar","Error","xml","decodeContents","document","config","scriptTags","inlineScript","forEach","script","attributes","src","dependencies","push","Logger","id","value","startsWith","contentNode","scriptFile","constructor","splitFile","scriptText","type","dataType","DataType","String","addNode","metaTag","paramTags","parameters","configFile","JSON","stringify","svgFile","encodeContents","combineNodes","sources","parse","stringValue","e","relative","message","nodeId","result","svg","s","i","unshift","splice"],"mappings":"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","sourcesContent":["import { DataType, VariantArrayType } from 'node-opcua/lib/datamodel/variant';\nimport Logger from 'gulplog';\nimport XMLTransformer from '../lib/transform/XMLTransformer';\nimport {\n  findChild, removeChild,\n  removeChildren,\n  createTextNode, createCDataNode, createElement,\n} from '../lib/helpers/xml';\n\n/**\n * Names of the tags to come before <metadata> in output files.\n * @type {Set<string>}\n */\nconst tagsBeforeMetadata = new Set(['defs', 'desc', 'title']);\n\n/**\n * Returns the index at which the <metadata> section should be inserted in the resulting xml.\n * @param {Object[]} elements The elements to look at.\n * @return {number} The insertion index.\n */\nfunction metadataIndex(elements) {\n  let index = 0;\n\n  while (elements.length > index && tagsBeforeMetadata.has(elements[index].name)) {\n    index += 1;\n  }\n\n  return index;\n}\n\n/**\n * Splits read atvise display XML nodes into their SVG and JavaScript sources,\n * alongside with a .json file containing the display's parameters.\n */\nexport default class DisplayTransformer extends XMLTransformer {\n\n  /**\n   * The extension to add to display container node names when they are pulled.\n   * @type {string}\n   */\n  static get extension() {\n    return '.display';\n  }\n\n  /**\n   * The source file extensions to allow.\n   * @type {string[]}\n   */\n  static get sourceExtensions() {\n    return ['.json', '.svg', '.js'];\n  }\n\n  /**\n   * Returns `true` for all display nodes.\n   * @param {Node} node The node to check.\n   */\n  shouldBeTransformed(node) {\n    return node.hasTypeDefinition('VariableTypes.ATVISE.Display');\n  }\n\n  /**\n   * Splits any read files containing atvise displays into their SVG and JavaScript sources,\n   * alongside with a json file containing the display's parameters.\n   * @param {BrowsedNode} node The node to split.\n   * @param {Object} context The transform context.\n   */\n  async transformFromDB(node, context) {\n    if (!this.shouldBeTransformed(node)) { return undefined; }\n\n    if (node.arrayType !== VariantArrayType.Scalar) {\n      // FIXME: Instead of throwing we could simply pass the original node to the callback\n      throw new Error('Array of displays not supported');\n    }\n\n    const xml = this.decodeContents(node);\n    if (!xml) { throw new Error('Error parsing display'); }\n\n    const document = findChild(xml, 'svg');\n    if (!document) { throw new Error('Error parsing display: No `svg` tag'); }\n\n    const config = {};\n    const scriptTags = removeChildren(document, 'script');\n    let inlineScript = false;\n\n    // Extract JavaScript\n    if (scriptTags.length) {\n      scriptTags.forEach(script => {\n        if (script.attributes && (script.attributes.src || script.attributes['xlink:href'])) {\n          if (!config.dependencies) {\n            config.dependencies = [];\n          }\n\n          config.dependencies.push(script.attributes.src || script.attributes['xlink:href']);\n        } else {\n          // Warn on multiple inline scripts\n          if (inlineScript) {\n            Logger[\n              node.id.value.startsWith('SYSTEM.LIBRARY.ATVISE') ? 'debug' : 'warn'\n            ](`'${node.id.value}' contains multiple inline scripts.`);\n            document.elements.push(inlineScript);\n          }\n          inlineScript = script;\n        }\n      });\n    }\n    if (inlineScript) {\n      const contentNode = inlineScript.elements ? inlineScript.elements[0] : createTextNode();\n      const scriptFile = this.constructor.splitFile(node, '.js');\n      const scriptText = contentNode[contentNode.type] || '';\n\n      scriptFile.value = {\n        dataType: DataType.String,\n        arrayType: VariantArrayType.Scalar,\n        value: scriptText,\n      };\n      context.addNode(scriptFile);\n    }\n\n    // Extract metadata\n    const metaTag = findChild(document, 'metadata');\n    if (metaTag && metaTag.elements) {\n      // TODO: Warn on multiple metadata tags\n\n      // - Parameters\n      const paramTags = removeChildren(metaTag, 'atv:parameter');\n      if (paramTags.length) {\n        config.parameters = [];\n\n        paramTags.forEach(({ attributes }) => config.parameters.push(attributes));\n      }\n    }\n\n    const configFile = this.constructor.splitFile(node, '.json');\n    configFile.value = {\n      dataType: DataType.String,\n      arrayType: VariantArrayType.Scalar,\n      value: JSON.stringify(config, null, '  '),\n    };\n    context.addNode(configFile);\n\n    const svgFile = this.constructor.splitFile(node, '.svg');\n    svgFile.value = {\n      dataType: DataType.String,\n      arrayType: VariantArrayType.Scalar,\n      value: this.encodeContents(xml),\n    };\n    context.addNode(svgFile);\n\n    // equals: node.renameTo(`${node.name}.display`);\n    return super.transformFromDB(node);\n  }\n\n  /**\n   * Creates a display from the collected nodes.\n   * @param {BrowsedNode} node The container node.\n   * @param {Map<string, BrowsedNode>} sources The collected files, stored against their\n   * extension.\n   */\n  combineNodes(node, sources) {\n    const configFile = sources['.json'];\n    let config = {};\n\n    if (configFile) {\n      try {\n        config = JSON.parse(configFile.stringValue);\n      } catch (e) {\n        throw new Error(`Error parsing JSON in ${configFile.relative}: ${e.message}`);\n      }\n    }\n\n    const svgFile = sources['.svg'];\n    if (!svgFile) {\n      throw new Error(`No display SVG for ${node.nodeId}`);\n    }\n\n    const scriptFile = sources['.js'];\n    let inlineScript = '';\n    if (scriptFile) {\n      inlineScript = scriptFile.stringValue;\n    }\n\n    const xml = this.decodeContents(svgFile);\n    const result = xml;\n    const svg = findChild(result, 'svg');\n\n    if (!svg) {\n      throw new Error('Error parsing display SVG: No `svg` tag');\n    }\n\n    // Handle empty svg tag\n    if (!svg.elements) {\n      svg.elements = [];\n    }\n\n    // Insert dependencies\n    if (config.dependencies) {\n      config.dependencies.forEach(s => {\n        svg.elements.push(createElement('script', undefined, { 'xlink:href': s }));\n      });\n    }\n\n    // Insert script\n    // FIXME: Import order is not preserved!\n    if (scriptFile) {\n      svg.elements.push(createElement('script', [createCDataNode(inlineScript)], {\n        type: 'text/ecmascript',\n      }));\n    }\n\n    // Insert metadata\n    // - Parameters\n    if (config.parameters && config.parameters.length > 0) {\n      let metaTag = removeChild(svg, 'metadata');\n\n      if (!metaTag) {\n        metaTag = createElement('metadata');\n      }\n\n      if (!metaTag.elements) {\n        metaTag.elements = [];\n      }\n\n      // Parameters should come before other atv attributes, e.g. `atv:gridconfig`\n      for (let i = config.parameters.length - 1; i >= 0; i--) {\n        metaTag.elements.unshift(\n          createElement('atv:parameter', undefined, config.parameters[i])\n        );\n      }\n\n      // Insert <metadata> as first element in the resulting svg, after <defs>, <desc> and\n      // <title> if defined\n      svg.elements.splice(metadataIndex(svg.elements), 0, metaTag);\n    }\n\n    // eslint-disable-next-line\n    node.value.value = this.encodeContents(result);\n    return node;\n  }\n\n}\n"],"file":"DisplayTransformer.js"}