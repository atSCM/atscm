{"version":3,"sources":["../../src/tasks/push.js"],"names":["openInBuilderStatus","Set","StatusCodes","BadUserAccessDenied","BadNotWritable","ignoredReferences","ReferenceTypeIds","toParent","HasTypeDefinition","HasModellingRule","performPush","path","options","applyTransforms","Transformer","combinedTransformer","ProjectConfig","useTransformers","TransformDirection","FromFilesystem","ensureReferences","node","references","reduce","result","key","value","has","Object","assign","map","s","keys","length","nodeId","then","outputArguments","failures","Error","join","Logger","debug","catch","err","Promise","resolve","create","NodeId","parentNodeId","parent","name","nodeClass","typeDefinition","modellingRule","reference","ReferenceTypeNames","getSingle","NodeClass","Variable","variantValue","createdNode","createFailed","warn","readNodeFile","r","reverse","t","undefined","handleNode","push","statusCode","Good","BadNodeIdUnknown","Session","pool","versionNode","originalError","version","required","dependencies","valid","split","promise","getter","browser","_pushedPath","size","formatter","count","finishTask","handleTaskError","description"],"mappings":"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","sourcesContent":["import { satisfies as validVersion } from 'semver';\nimport Logger from 'gulplog';\nimport { StatusCodes } from 'node-opcua/lib/datamodel/opcua_status_code';\nimport { NodeClass } from 'node-opcua/lib/datamodel/nodeclass';\nimport src from '../lib/gulp/src';\nimport { readNode, writeNode, createNode, addReferences } from '../api';\nimport { versionNode } from '../lib/server/scripts/version';\nimport { dependencies } from '../../package.json';\nimport Transformer, { TransformDirection } from '../lib/transform/Transformer.js';\nimport NodeId from '../lib/model/opcua/NodeId.js';\nimport { ReferenceTypeIds, ReferenceTypeNames } from '../lib/model/Node';\nimport { reportProgress } from '../lib/helpers/log.js';\nimport ProjectConfig from '../config/ProjectConfig.js';\nimport { finishTask, handleTaskError } from '../lib/helpers/tasks.js';\nimport Session from '../lib/server/Session.js';\n\n/**\n * Status codes indicating a node is opened in atvise builder and therefore not writable right now.\n * @type {Set<node-opcua~StatusCodes>}\n */\nconst openInBuilderStatus = new Set([\n  StatusCodes.BadUserAccessDenied,\n  StatusCodes.BadNotWritable,\n]);\n\n/**\n * The reference types ignored when adding references. The corresponding references are created\n * alongside the node itself using the 'CreateNode' server script.\n * @type {Set<node-opcua~ReferenceTypeId>}\n */\nconst ignoredReferences = new Set([\n  ReferenceTypeIds.toParent,\n  ReferenceTypeIds.HasTypeDefinition,\n  ReferenceTypeIds.HasModellingRule,\n]);\n\n/**\n * Pushes the given path to the server.\n * @param {string} path The local path to push.\n * @param {Object} options Options passed to {@link src}.\n */\nexport function performPush(path, options) {\n  const applyTransforms = Transformer.combinedTransformer(\n    ProjectConfig.useTransformers, TransformDirection.FromFilesystem);\n\n  const ensureReferences = node => {\n    const references = [...node.references]\n      .reduce((result, [key, value]) => {\n        if (ignoredReferences.has(key)) { return result; }\n\n        return Object.assign(result, {\n          [key]: [...value].map(s => (typeof s === 'string' ? `ns=1;s=${s}` : s)),\n        });\n      }, {});\n\n    if (Object.keys(references).length > 0) {\n      return addReferences(node.nodeId, references)\n        .then(({ outputArguments }) => {\n          const [{ value: failures }] = outputArguments[3].value;\n\n          if (failures) {\n            throw new Error(`Failed to create reference(s) from ${node.nodeId} to ${\n              failures.join(', ')}`);\n          } else {\n            Logger.debug(`Added ${Object.keys(references).length} reference(s) to ${node.nodeId}`);\n          }\n        })\n        .catch(err => { throw Object.assign(err, { node }); });\n    }\n\n    return Promise.resolve();\n  };\n\n  const create = node => {\n    const nodeId = new NodeId(node.nodeId);\n    let parentNodeId = node.parent && node.parent.nodeId;\n\n    if (!node.parent) {\n      parentNodeId = nodeId.parent;\n      Logger.debug(`Assuming ${parentNodeId} as parent of ${node.nodeId}`);\n    }\n\n    return createNode(nodeId, {\n      name: node.name,\n      parentNodeId,\n      nodeClass: node.nodeClass,\n      typeDefinition: node.typeDefinition,\n      modellingRule: node.modellingRule,\n      reference: ReferenceTypeNames[node.references.getSingle(ReferenceTypeIds.toParent)],\n      value: node.nodeClass === NodeClass.Variable && node.variantValue,\n    })\n      .then(({ outputArguments }) => {\n        const [{ value: createdNode }, { value: createFailed }] = outputArguments[3].value;\n\n        if (createFailed) {\n          Logger.warn('Failed to create node', node.nodeId);\n          return Promise.resolve();\n        } else if (createdNode) {\n          Logger.debug('Created node', node.nodeId);\n        } else {\n          // Node already existed\n        }\n\n        return ensureReferences(node);\n      })\n      .catch(err => { throw Object.assign(err, { node }); });\n  };\n\n  return src(path, {\n    ...options,\n    readNodeFile(node) {\n      const r = ProjectConfig.useTransformers.reverse()\n        .reduce((result, t) => (result === undefined ?\n          t.readNodeFile(node) :\n          result),\n        undefined);\n      return r === undefined ? true : r;\n    },\n    async handleNode(node) {\n      // NOTE: context = this\n      await applyTransforms(node, this);\n\n      if (node.push === false) { // Skip write\n        return false;\n      }\n\n      // Create / write node\n      if (node.nodeClass !== NodeClass.Variable) {\n        return create(node);\n      }\n\n      // console.error('write', node.nodeId, node.value);\n      return writeNode(`ns=1;s=${node.nodeId}`, node.variantValue)\n        .then(\n          () => ensureReferences(node),\n          err => {\n            if (openInBuilderStatus.has(err.statusCode)) {\n              Logger.warn(`Error writing node ${\n                node.nodeId\n              }\n    - Make sure it is not opened in atvise builder\n    - Make sure the corresponding datasource is connected`);\n              return StatusCodes.Good;\n            }\n\n            if (err.statusCode === StatusCodes.BadNodeIdUnknown) {\n              Logger.debug(`Node ${\n                node.nodeId\n              } does not exist: Attempting to create it...`);\n\n              return create(node);\n            }\n\n            throw Object.assign(err, { node });\n          }\n        );\n    },\n  });\n}\n\n/**\n * Pushes {@link AtviseFile}s to atvise server.\n */\nexport default function push() {\n  Session.pool();\n\n  Logger.debug('Checking server setup');\n\n  return readNode(versionNode)\n    .catch(err => {\n      if (err.statusCode && err.statusCode === StatusCodes.BadNodeIdUnknown) {\n        throw Object.assign(new Error(`Invalid server scripts version\n- Please run 'atscm import' again to update`), { originalError: err });\n      }\n\n      throw err;\n    })\n    .then(({ value: version }) => {\n      const required = dependencies['@atscm/server-scripts'];\n      Logger.debug(`Found server scripts version: ${version}`);\n\n      try {\n        const valid = validVersion(version.split('-beta')[0], required);\n\n        return { version, valid, required };\n      } catch (err) {\n        throw Object.assign(new Error(`Invalid server scripts version\n- Please run 'atscm import' again to update`), { originalError: err });\n      }\n    })\n    .then(({ valid, version, required }) => {\n      if (!valid) {\n        throw new Error(`Invalid server scripts version: ${version} (${required} required)\n- Please run 'atscm import' again to update`);\n      }\n    })\n    .then(() => {\n      const promise = performPush('./src');\n\n      return reportProgress(promise, {\n        getter: () => promise.browser._pushedPath.size,\n        formatter: count => `Processed ${count} files`,\n      });\n    })\n    .then(finishTask, handleTaskError);\n}\n\npush.description = 'Push all stored nodes to atvise server';\n"],"file":"push.js"}