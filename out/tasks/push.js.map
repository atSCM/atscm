{"version":3,"sources":["../../src/tasks/push.js"],"names":["openInBuilderStatus","Set","StatusCodes","BadUserAccessDenied","BadNotWritable","ignoredReferences","ReferenceTypeIds","toParent","HasTypeDefinition","HasModellingRule","performPush","path","options","applyTransforms","Transformer","combinedTransformer","ProjectConfig","useTransformers","TransformDirection","FromFilesystem","ensureReferences","node","references","reduce","result","key","value","has","Object","assign","map","s","keys","length","nodeId","then","outputArguments","failures","Error","join","Logger","debug","catch","err","Promise","resolve","create","NodeId","parentNodeId","parent","name","nodeClass","typeDefinition","modellingRule","reference","ReferenceTypeNames","getSingle","NodeClass","Variable","variantValue","createdNode","createFailed","warn","readNodeFile","r","reverse","t","undefined","handleNode","push","statusCode","Good","BadNodeIdUnknown","Session","pool","versionNode","originalError","version","required","dependencies","valid","split","promise","getter","browser","_pushedPath","size","formatter","count","finishTask","handleTaskError","description"],"mappings":"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","sourcesContent":["import { satisfies as validVersion } from 'semver';\nimport Logger from 'gulplog';\nimport { StatusCodes } from 'node-opcua/lib/datamodel/opcua_status_code';\nimport { NodeClass } from 'node-opcua/lib/datamodel/nodeclass';\nimport src from '../lib/gulp/src';\nimport { readNode, writeNode, createNode, addReferences } from '../api';\nimport { versionNode } from '../lib/server/scripts/version';\nimport { dependencies } from '../../package.json';\nimport Transformer, { TransformDirection } from '../lib/transform/Transformer.js';\nimport NodeId from '../lib/model/opcua/NodeId.js';\nimport { ReferenceTypeIds, ReferenceTypeNames } from '../lib/model/Node';\nimport { reportProgress } from '../lib/helpers/log.js';\nimport ProjectConfig from '../config/ProjectConfig.js';\nimport { finishTask, handleTaskError } from '../lib/helpers/tasks.js';\nimport Session from '../lib/server/Session.js';\n\n/**\n * Status codes indicating a node is opened in atvise builder and therefore not writable right now.\n * @type {Set<node-opcua~StatusCodes>}\n */\nconst openInBuilderStatus = new Set([StatusCodes.BadUserAccessDenied, StatusCodes.BadNotWritable]);\n\n/**\n * The reference types ignored when adding references. The corresponding references are created\n * alongside the node itself using the 'CreateNode' server script.\n * @type {Set<node-opcua~ReferenceTypeId>}\n */\nconst ignoredReferences = new Set([\n  ReferenceTypeIds.toParent,\n  ReferenceTypeIds.HasTypeDefinition,\n  ReferenceTypeIds.HasModellingRule,\n]);\n\n/**\n * Pushes the given path to the server.\n * @param {string} path The local path to push.\n * @param {Object} options Options passed to {@link src}.\n */\nexport function performPush(path, options) {\n  const applyTransforms = Transformer.combinedTransformer(\n    ProjectConfig.useTransformers,\n    TransformDirection.FromFilesystem\n  );\n\n  const ensureReferences = node => {\n    const references = [...node.references].reduce((result, [key, value]) => {\n      if (ignoredReferences.has(key)) {\n        return result;\n      }\n\n      return Object.assign(result, {\n        [key]: [...value].map(s => (typeof s === 'string' ? `ns=1;s=${s}` : s)),\n      });\n    }, {});\n\n    if (Object.keys(references).length > 0) {\n      return addReferences(node.nodeId, references)\n        .then(({ outputArguments }) => {\n          const [{ value: failures }] = outputArguments[3].value;\n\n          if (failures) {\n            throw new Error(\n              `Failed to create reference(s) from ${node.nodeId} to ${failures.join(', ')}`\n            );\n          } else {\n            Logger.debug(`Added ${Object.keys(references).length} reference(s) to ${node.nodeId}`);\n          }\n        })\n        .catch(err => {\n          throw Object.assign(err, { node });\n        });\n    }\n\n    return Promise.resolve();\n  };\n\n  const create = node => {\n    const nodeId = new NodeId(node.nodeId);\n    let parentNodeId = node.parent && node.parent.nodeId;\n\n    if (!node.parent) {\n      parentNodeId = nodeId.parent;\n      Logger.debug(`Assuming ${parentNodeId} as parent of ${node.nodeId}`);\n    }\n\n    return createNode(nodeId, {\n      name: node.name,\n      parentNodeId,\n      nodeClass: node.nodeClass,\n      typeDefinition: node.typeDefinition,\n      modellingRule: node.modellingRule,\n      reference: ReferenceTypeNames[node.references.getSingle(ReferenceTypeIds.toParent)],\n      value:\n        node.nodeClass && node.nodeClass.value === NodeClass.Variable.value && node.variantValue,\n    })\n      .then(({ outputArguments }) => {\n        const [{ value: createdNode }, { value: createFailed }] = outputArguments[3].value;\n\n        if (createFailed) {\n          Logger.warn('Failed to create node', node.nodeId);\n          return Promise.resolve();\n        } else if (createdNode) {\n          Logger.debug('Created node', node.nodeId);\n        } else {\n          // Node already existed\n        }\n\n        return ensureReferences(node);\n      })\n      .catch(err => {\n        throw Object.assign(err, { node });\n      });\n  };\n\n  return src(path, {\n    ...options,\n    readNodeFile(node) {\n      const r = ProjectConfig.useTransformers\n        .reverse()\n        .reduce((result, t) => (result === undefined ? t.readNodeFile(node) : result), undefined);\n      return r === undefined ? true : r;\n    },\n    async handleNode(node) {\n      // NOTE: context = this\n      await applyTransforms(node, this);\n\n      if (node.push === false) {\n        // Skip write\n        return false;\n      }\n\n      // Create / write node\n      if (node.nodeClass.value !== NodeClass.Variable.value) {\n        return create(node);\n      }\n\n      // console.error('write', node.nodeId, node.value);\n      return writeNode(`ns=1;s=${node.nodeId}`, node.variantValue).then(\n        () => ensureReferences(node),\n        err => {\n          if (openInBuilderStatus.has(err.statusCode)) {\n            Logger.warn(`Error writing node ${node.nodeId}\n    - Make sure it is not opened in atvise builder\n    - Make sure the corresponding datasource is connected`);\n            return StatusCodes.Good;\n          }\n\n          if (err.statusCode === StatusCodes.BadNodeIdUnknown) {\n            Logger.debug(`Node ${node.nodeId} does not exist: Attempting to create it...`);\n\n            return create(node);\n          }\n\n          throw Object.assign(err, { node });\n        }\n      );\n    },\n  });\n}\n\n/**\n * Pushes {@link AtviseFile}s to atvise server.\n */\nexport default function push() {\n  Session.pool();\n\n  Logger.debug('Checking server setup');\n\n  return readNode(versionNode)\n    .catch(err => {\n      if (err.statusCode && err.statusCode === StatusCodes.BadNodeIdUnknown) {\n        throw Object.assign(\n          new Error(`Invalid server scripts version\n- Please run 'atscm import' again to update`),\n          { originalError: err }\n        );\n      }\n\n      throw err;\n    })\n    .then(({ value: version }) => {\n      const required = dependencies['@atscm/server-scripts'];\n      Logger.debug(`Found server scripts version: ${version}`);\n\n      try {\n        const valid = validVersion(version.split('-beta')[0], required);\n\n        return { version, valid, required };\n      } catch (err) {\n        throw Object.assign(\n          new Error(`Invalid server scripts version\n- Please run 'atscm import' again to update`),\n          { originalError: err }\n        );\n      }\n    })\n    .then(({ valid, version, required }) => {\n      if (!valid) {\n        throw new Error(`Invalid server scripts version: ${version} (${required} required)\n- Please run 'atscm import' again to update`);\n      }\n    })\n    .then(() => {\n      const promise = performPush('./src');\n\n      return reportProgress(promise, {\n        getter: () => promise.browser._pushedPath.size,\n        formatter: count => `Processed ${count} files`,\n      });\n    })\n    .then(finishTask, handleTaskError);\n}\n\npush.description = 'Push all stored nodes to atvise server';\n"],"file":"push.js"}