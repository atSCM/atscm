{"version":3,"sources":["../../src/tasks/pull.js"],"names":["performPull","nodes","options","writeStream","applyTransforms","Transformer","combinedTransformer","ProjectConfig","useTransformers","TransformDirection","FromDB","browser","NodeBrowser","handleNode","node","transform","context","_added","addNode","n","push","writeAsync","length","forEach","Object","assign","browse","pull","clean","process","argv","slice","Promise","resolve","then","Logger","info","promise","getter","_pushed","formatter","count","description"],"mappings":";;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;AAEO,SAASA,WAAT,CAAqBC,KAArB,EAA4BC,OAAO,GAAG,EAAtC,EAA0C;AAC/C,QAAMC,WAAW,GAAG,mBAAK,OAAL,CAApB;;AACA,QAAMC,eAAe,GAAGC,qBAAYC,mBAAZ,CACtBC,uBAAcC,eADQ,EACSC,gCAAmBC,MAD5B,CAAxB;;AAGA,QAAMC,OAAO,GAAG,IAAIC,oBAAJ,mBACXV,OADW;AAEd,UAAMW,UAAN,CAAiBC,IAAjB,EAAuB;AAAEC,MAAAA,SAAS,GAAG;AAAd,QAAuB,EAA9C,EAAkD;AAChD,YAAMC,OAAO,GAAG;AACdC,QAAAA,MAAM,EAAE,EADM;;AAEdC,QAAAA,OAAO,CAACC,CAAD,EAAI;AACT,eAAKF,MAAL,CAAYG,IAAZ,CAAiBD,CAAjB;AACD;;AAJa,OAAhB;;AAOA,UAAIJ,SAAJ,EAAe;AACb,cAAMX,eAAe,CAACU,IAAD,EAAOE,OAAP,CAArB;AACD;;AAED,YAAMb,WAAW,CAACkB,UAAZ,CAAuBP,IAAvB,CAAN,CAZgD,CAchD;;AACA,UAAIE,OAAO,CAACC,MAAR,CAAeK,MAAnB,EAA2B;AACzBN,QAAAA,OAAO,CAACC,MAAR,CAAeM,OAAf,CAAuBJ,CAAC,IAAI,KAAKD,OAAL,CAAaC,CAAb,CAA5B;AACD;AACF;;AApBa,KAAhB;AAuBA,SAAOK,MAAM,CAACC,MAAP,CAAcd,OAAO,CAACe,MAAR,CAAezB,KAAf,CAAd,EAAqC;AAAEU,IAAAA;AAAF,GAArC,CAAP;AACD;AAED;;;;;;;AAKe,SAASgB,IAAT,CAAczB,OAAd,EAAuB;AACpC,QAAM;AAAE0B,IAAAA;AAAF,MAAY,OAAO1B,OAAP,KAAmB,QAAnB,GAA8BA,OAA9B,GAAwC,kBAAa2B,OAAO,CAACC,IAAR,CAAaC,KAAb,CAAmB,CAAnB,CAAb,CAA1D;AAEA,SAAOC,OAAO,CAACC,OAAR,GACJC,IADI,CACC,MAAM;AACV,QAAIN,KAAJ,EAAW;AACTO,uBAAOC,IAAP,CAAY,4CAAZ;;AACA,aAAO,uBAAS,OAAT,CAAP;AACD;;AAED,WAAOJ,OAAO,CAACC,OAAR,EAAP;AACD,GARI,EASJC,IATI,CASC,MAAM;AACV,UAAMG,OAAO,GAAGrC,WAAW,CAACO,uBAAcN,KAAf,CAA3B;AAEA,WAAO,yBAAeoC,OAAf,EAAwB;AAC7BC,MAAAA,MAAM,EAAE,MAAMD,OAAO,CAAC1B,OAAR,CAAgB4B,OADD;AAE7BC,MAAAA,SAAS,EAAEC,KAAK,IAAK,aAAYA,KAAM;AAFV,KAAxB,CAAP;AAID,GAhBI,CAAP;AAiBD;;AAEDd,IAAI,CAACe,WAAL,GAAmB,mCAAnB","sourcesContent":["import parseOptions from 'mri';\nimport { emptyDir } from 'fs-extra';\nimport Logger from 'gulplog';\nimport NodeBrowser from '../lib/server/NodeBrowser';\nimport ProjectConfig from '../config/ProjectConfig';\nimport Transformer, { TransformDirection } from '../lib/transform/Transformer.js';\nimport dest from '../lib/gulp/dest';\nimport { reportProgress } from '../lib/helpers/log';\n\nexport function performPull(nodes, options = {}) {\n  const writeStream = dest('./src');\n  const applyTransforms = Transformer.combinedTransformer(\n    ProjectConfig.useTransformers, TransformDirection.FromDB);\n\n  const browser = new NodeBrowser({\n    ...options,\n    async handleNode(node, { transform = true } = {}) {\n      const context = {\n        _added: [],\n        addNode(n) {\n          this._added.push(n);\n        },\n      };\n\n      if (transform) {\n        await applyTransforms(node, context);\n      }\n\n      await writeStream.writeAsync(node);\n\n      // Enqueue added nodes\n      if (context._added.length) {\n        context._added.forEach(n => this.addNode(n));\n      }\n    },\n  });\n\n  return Object.assign(browser.browse(nodes), { browser });\n}\n\n/**\n * Pulls all nodes from atvise server.\n * @param {Object} [options] The options to use.\n * @param {boolean} [options.clean] If the source directory should be cleaned first.\n */\nexport default function pull(options) {\n  const { clean } = typeof options === 'object' ? options : parseOptions(process.argv.slice(2));\n\n  return Promise.resolve()\n    .then(() => {\n      if (clean) {\n        Logger.info('Using --clean, removing pulled files first');\n        return emptyDir('./src');\n      }\n\n      return Promise.resolve();\n    })\n    .then(() => {\n      const promise = performPull(ProjectConfig.nodes);\n\n      return reportProgress(promise, {\n        getter: () => promise.browser._pushed,\n        formatter: count => `Processed ${count} nodes`,\n      });\n    });\n}\n\npull.description = 'Pull all nodes from atvise server';\n"],"file":"pull.js"}