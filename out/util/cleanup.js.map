{"version":3,"sources":["../../src/util/cleanup.js"],"names":["cleanup","exitCode","signal","uninstall","clearLine","process","stdout","cursorTo","warn","debug","open","length","removeAllListeners","on","closeOpen","then","kill","pid","catch","e","error","message"],"mappings":";;;;;kBAWwBA,O;;AAXxB;;;;AACA;;;;AACA;;;;;;AAEA;;;;;;;AAOe,SAASA,OAAT,CAAiBC,QAAjB,EAA2BC,MAA3B,EAAmCC,SAAnC,EAA8C;AAC3DA;;AAEA,MAAID,WAAW,QAAf,EAAyB;AACvB,uBAASE,SAAT,CAAmBC,QAAQC,MAA3B;AACA,uBAASC,QAAT,CAAkBF,QAAQC,MAA1B,EAAkC,CAAlC;AACA,sBAAOE,IAAP,CAAY,QAAZ;AACD;;AAED,oBAAOC,KAAP,CAAa,oBAAb;;AAEA,MAAI,kBAAQC,IAAR,CAAaC,MAAb,GAAsB,CAA1B,EAA6B;AAC3B,sBAAOF,KAAP,CAAa,WAAb,EAA0B,kBAAQC,IAAR,CAAaC,MAAvC,EAA+C,kBAA/C;;AAEA;AACA,sBAAOC,kBAAP,CAA0B,OAA1B;AACA,sBAAOC,EAAP,CAAU,OAAV,EAAmB,MAAM,CAAE,CAA3B;;AAEA,sBAAQC,SAAR,GACGC,IADH,CACQ,MAAMV,QAAQW,IAAR,CAAaX,QAAQY,GAArB,EAA0Bf,MAA1B,CADd,EAEGgB,KAFH,CAESC,KAAK;AACV,wBAAOC,KAAP,CAAa,kBAAb,EAAiCD,EAAEE,OAAnC;AACAhB,cAAQW,IAAR,CAAaX,QAAQY,GAArB,EAA0Bf,MAA1B;AACD,KALH;;AAOA,WAAO,KAAP;AACD;;AAED,SAAO,IAAP;AACD","file":"cleanup.js","sourcesContent":["import readline from 'readline';\nimport Logger from 'gulplog';\nimport Session from '../lib/server/Session';\n\n/**\n * Cleans up after the app ended with the specified code or signal.\n * @param {?Number} exitCode The exit code received.\n * @param {?string} signal The signal that triggered the exit.\n * @param {function()} uninstall\n * @return {boolean} `true` if the process should continue exiting.\n */\nexport default function cleanup(exitCode, signal, uninstall) {\n  uninstall();\n\n  if (signal === 'SIGINT') {\n    readline.clearLine(process.stdout);\n    readline.cursorTo(process.stdout, 0);\n    Logger.warn('Ctrl-C');\n  }\n\n  Logger.debug('Running cleanup...');\n\n  if (Session.open.length > 0) {\n    Logger.debug('  Closing', Session.open.length, 'open sessions...');\n\n    // Ignore further gulp error messages\n    Logger.removeAllListeners('error');\n    Logger.on('error', () => {});\n\n    Session.closeOpen()\n      .then(() => process.kill(process.pid, signal))\n      .catch(e => {\n        Logger.error('Error in cleanup', e.message);\n        process.kill(process.pid, signal);\n      });\n\n    return false;\n  }\n\n  return true;\n}\n"]}