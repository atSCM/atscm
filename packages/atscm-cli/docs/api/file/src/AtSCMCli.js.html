<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/AtSCMCli.js | atscm-cli API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/atSCM/atscm-cli" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/AtSCMCli.js~AtSCMCli.html">AtSCMCli</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">cli</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Commands">Commands</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GlobalOptions">GlobalOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Options">Options</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">cli/commands</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cli/commands/Config.js~ConfigCommand.html">ConfigCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cli/commands/Docs.js~DocsCommand.html">DocsCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cli/commands/Init.js~InitCommand.html">InitCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cli/commands/Run.js~RunCommand.html">RunCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/cli/commands/Update.js~UpdateCommand.html">UpdateCommand</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/cli</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/cli/Command.js~Command.html">Command</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/cli/Option.js~Option.html">Option</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/error</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/error/UsageError.js~UsageError.html">UsageError</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/util</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/util/ExternalCommand.js~ExternalCommand.html">ExternalCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/util/Logger.js~LogFormat.html">LogFormat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/util/Logger.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">typedef</div><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Liftoff.Environment">Liftoff.Environment</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/js-cli/js-liftoff">Liftoff</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/chalk/chalk">chalk</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/gulpjs/gulplog">gulplog</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/child_process.html#child_process_class_childprocess">node.ChildProcess</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/stream.html#stream_class_stream_readable">node.stream.Readable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://yargs.js.org">yargs</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/AtSCMCli.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { realpathSync } from &apos;fs&apos;;
import { join } from &apos;path&apos;;
import Liftoff from &apos;liftoff&apos;;
import yargs from &apos;yargs&apos;;
import gulplog from &apos;gulplog&apos;;
import { jsVariants } from &apos;interpret&apos;;
import pkg from &apos;../package.json&apos;;
import Logger from &apos;./lib/util/Logger&apos;;
import Options, { GlobalOptions } from &apos;./cli/Options&apos;;
import Commands from &apos;./cli/Commands&apos;;
import UsageError from &apos;./lib/error/UsageError&apos;;

/**
 * The main class. Handles arguments and runs commands.
 * @extends {Liftoff}
 */
export default class AtSCMCli extends Liftoff {

  /**
   * The name under which the module is available from the command line.
   * @type {String}
   */
  static get BinName() {
    return Object.keys(pkg.bin)[0];
  }

  /**
   * The filename used for configuration files.
   * @type {String}
   */
  static get ConfigName() {
    return &apos;Atviseproject&apos;;
  }

  /**
   * Reports an error and exits the process with return code `1`.
   * @param {Error} err The error that occurred.
   */
  _reportCliError(err) {
    Logger.error(Logger.colors.red(err.message));

    if (err instanceof UsageError) {
      Logger.info(err.help);
    } else {
      Logger.debug(err.stack);
    }

    process.exitCode = 1;
  }

  /**
   * Creates a new {@link AtSCMCli} object based on command line arguments.
   * @param {String[]} argv The command line arguments to use. If no command is provided and neither
   * `--help` nor `--version` are used, the command `run` is added.
   * @throws {UsageError} Throws an error if option parsing fails.
   */
  constructor(argv = []) {
    super({
      name: AtSCMCli.BinName,
      configName: AtSCMCli.ConfigName,
      extensions: jsVariants,
    });

    this.on(&apos;require&apos;, function(name) {
      Logger.debug(&apos;Requiring external module&apos;, Logger.colors.magenta(name));
    });

    this.on(&apos;requireFail&apos;, function(name) {
      Logger.error(
        Logger.colors.red(&apos;Failed to load external module&apos;),
        Logger.colors.magenta(name)
      );
    });

    /**
     * `true` if the instance was created by running the binaries, `false` if used programmatically.
     * @type {Boolean}
     */
    this.runViaCli = realpathSync(process.argv[1]) === require.resolve(&apos;./bin/atscm&apos;);

    /**
     * The raw, unparsed command line arguments the Cli was created with.
     * @type {String[]}
     */
    this._argv = argv;

    // If no command is given, default to &quot;run&quot;
    const commandNames = Commands.map(c =&gt; c.name);

    /**
     * The options parsed from {@link AtSCMCli#_argv}. Note that **these options are not complete**
     * until {@link AtSCMCli#launch} was called.
     * @type {Object}
     */
    this.options = yargs(argv)
      .env(&apos;ATSCM&apos;)
      .option(GlobalOptions)
      .fail((msg, e, y) =&gt; {
        const err = new UsageError(msg, y.help());

        if (this.runViaCli) {
          gulplog.on(&apos;error&apos;, () =&gt; {}); // Prevent logger to throw an error

          this._reportCliError(err);
        } else {
          throw err;
        }
      })
      .argv;

    if (!this.options.help &amp;&amp; !this.options.version) {
      if (this.options._.filter(e =&gt; commandNames.includes(e)).length === 0) {
        this._argv.unshift(&apos;run&apos;);
      }
    }

    // Initialize logger
    Logger.applyOptions(this.options);

    const globalOptionNames = Object.keys(GlobalOptions);

    /**
     * An instance of {@link yargs} responible for parsing options.
     * @type {yargs}
     */
    this.argumentsParser = Commands
      .reduce(
        (parser, command) =&gt; parser
          .command(command.usage, command.description, y =&gt; {
            y.usage(`Usage: $0 ${command.usage}`);
            y.option(command.options);

            y.group(Object.keys(command.options), &apos;Command specific options:&apos;);
            y.group(globalOptionNames, &apos;Global options:&apos;);

            y.strict();
            y.help(&apos;help&apos;, Options.help.desc);
            y.demandCommand(...command.demandCommand);
          }, () =&gt; (this.command = command)),
        yargs()
          .env(&apos;ATSCM&apos;)
          .usage(&apos;Usage: $0 [cmd=run]&apos;)
          .options(GlobalOptions)
          .global(globalOptionNames)
          .strict()
          .help(&apos;help&apos;, Options.help.desc)
          .alias(&apos;help&apos;, &apos;h&apos;)
      );
  }

  /**
   * Used to expose project config overrides via environment variables. All project options are
   * exposed as `ATSCM_PROJECT__{KEY}={VALUE}`.
   * @param {Object} config The object to expose.
   * @param {string} key The key currently handled.
   * @param {string} [base=ATSCM_PROJECT__] The parent key.
   */
  _exposeOverride(config, key, base = &apos;ATSCM_PROJECT__&apos;) {
    const currentKey = `${base}${key.toUpperCase()}`;

    if (typeof config[key] === &apos;object&apos;) {
      const c = config[key];

      Object.keys(c).forEach(k =&gt; this._exposeOverride(c, k, `${currentKey}__`));
    } else {
      process.env[currentKey] = config[key];
      Logger.debug(`Setting ${currentKey}:`, Logger.format.value(config[key]));
    }
  }

  /**
   * Parses arguments and exposes the project options as environment variables.
   * @return {Promise&lt;Object, UsageError&gt;} Rejected with a {@link UsageError} if parsing failed,
   * otherwise fulfilled with the parsed arguments.
   */
  parseArguments() {
    return new Promise((resolve, reject) =&gt; {
      this.options = this.argumentsParser
        .fail((msg, err, y) =&gt; reject(new UsageError(msg, y.help())))
        .parse(this._argv);

      Object.keys(this.options.project)
        .forEach(key =&gt; this._exposeOverride(this.options.project, key));

      resolve(this.options);
    });
  }

  /**
   * Returns a {@link Liftoff.Environment} for the Cli.
   * @param {Boolean} [findUp=false] If the environment should be searched for in parent
   * directories.
   * @return {Promise&lt;Object&gt;} Fulfilled with a {@link Liftoff} environment.
   */
  getEnvironment(findUp = true) {
    return new Promise(resolve =&gt; {
      super.launch({
        cwd: this.options.cwd,
        configPath: findUp ?
          this.options.projectfile :
          join((this.options.cwd || process.cwd()), `${this.constructor.ConfigName}.js`),
        require: this.options.require,
      }, env =&gt; resolve(this.environment = env));
    });
  }

  /**
   * Gets a {@link Liftoff.Environment} and validates a config file and a local module was found.
   * @return {Promise&lt;Object, Error&gt;} Resolved with the {@link Liftoff environment}, rejected if the
   * config file or the local module cannot be found.
   */
  requireEnvironment() {
    return this.getEnvironment()
      .then(env =&gt; {
        if (!env.modulePath) {
          throw new Error(`Local ${AtSCMCli.BinName} not found`);
        }

        if (!env.configPath) {
          throw new Error(&apos;No config file found&apos;);
        }

        return env;
      });
  }

  /**
   * Returns the CLI version and, if a local module could be found, the local version.
   * @return {Promise&lt;{cli: String, local: ?String}&gt;} Fulfilled with the found cli and local
   * version.
   */
  getVersion() {
    return this.getEnvironment()
      .then(env =&gt; ({
        cli: pkg.version,
        local: env.modulePath ? env.modulePackage.version : null,
      }));
  }

  /**
   * Gets and prints the CLI version and, if a local module could be found, the local version.
   * @return {Promise&lt;{cli: String, local: ?String}&gt;} Fulfilled with the found cli and local
   * version.
   */
  printVersion() {
    return this.getVersion()
      .then(version =&gt; {
        Logger.info(&apos;CLI version&apos;, Logger.format.number(version.cli));

        if (version.local) {
          Logger.info(&apos;Local version&apos;, Logger.format.number(version.local));
        }

        return version;
      });
  }

  /**
   * Runs the command specified in the command line arguments ({@link AtSCMCli#_argv}). **Note that
   * this will only work if {@link AtSCMCli#parseArguments} was called before.**
   * @return {Promise&lt;*, Error&gt;} Fulfilled if the command succeeded.
   */
  runCommand() {
    if (this.options.version) {
      return this.printVersion();
    }

    if (this.command) {
      return (this.command.requiresEnvironment(this) ?
        this.requireEnvironment() :
        Promise.resolve()
      )
        .then(() =&gt; this.command.run(this));
    }

    Logger.warn(&apos;No command specified&apos;);

    return Promise.resolve(this);
  }

  /**
   * Parses arguments and runs the specified command.
   * @return {Promise&lt;*, Error&gt;} Fulfilled if the command succeeded. Note that, if the instance is
   * run through the binary all rejections will be handled.
   */
  launch() {
    const app = this.parseArguments()
      .then(() =&gt; this.runCommand());

    if (this.runViaCli) {
      return app
        .catch(err =&gt; this._reportCliError(err));
    }

    return app;
  }

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
