{"version":3,"sources":["../../src/transform/ScriptTransformer.ts"],"names":["AtviseScriptTransformer","XMLTransformer","scriptSourceExtension","sourceExtensions","processMetadata","document","config","metaTag","childNodes","forEach","child","type","name","icon","Object","assign","content","visible","Boolean","parseInt","title","undefined","description","metadata","value","soFar","Array","isArray","push","includes","Logger","debug","processParameters","paramTags","length","map","node","attributes","sortedAttributeValues","param","relative","target","find","isElement","index","tagName","parsedIndex","namespaceIndex","isNaN","transformFromDB","context","shouldBeTransformed","arrayType","VariantArrayType","Scalar","Error","warn","id","remove","xml","decodeContents","parameters","configFile","constructor","splitFile","dataType","DataType","String","JSON","stringify","addNode","codeNode","scriptFile","combineNodes","sources","parse","stringValue","e","message","code","result","meta","isQuickDynamic","iconConfig","entries","v","elements","targetElements","encodeContents","ServerscriptTransformer","extension","isVariable","isScript","QuickDynamicTransformer","DisplayScriptTransformer","isDisplayScript"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AAaA;;;;;;;;;;;;;;AAIA;;;;AAIO,MAAMA,uBAAN,SAAsCC,uBAAtC,CAAqD;AAC1D;;;AAGA,aAAWC,qBAAX,GAAmC;AACjC,WAAO,KAAP;AACD;AAED;;;;;;AAIA,aAAWC,gBAAX,GAA8B;AAC5B,WAAO,CAAC,OAAD,EAAU,KAAKD,qBAAf,CAAP;AACD;AAED;;;;;;;AAKAE,EAAAA,eAAe,CAACC,QAAD,EAAW;AACxB,UAAMC,MAA0B,GAAG,EAAnC;AAEA,UAAMC,OAAO,GAAG,0BAAUF,QAAV,EAAoB,UAApB,CAAhB,CAHwB,CAIxB;;AACA,QAAI,CAACE,OAAD,IAAY,CAACA,OAAO,CAACC,UAAzB,EAAqC;AACnC,aAAOF,MAAP;AACD;;AAEDC,IAAAA,OAAO,CAACC,UAAR,CAAmBC,OAAnB,CAA4BC,KAAD,IAAW;AAAA;;AACpC,UAAIA,KAAK,CAACC,IAAN,KAAe,SAAnB,EAA8B;AAC5B;AACD;;AAED,cAAQD,KAAK,CAACE,IAAd;AACE,aAAK,MAAL;AACEN,UAAAA,MAAM,CAACO,IAAP,GAAcC,MAAM,CAACC,MAAP,CACZ;AACEC,YAAAA,OAAO,EAAE,4BAAYN,KAAZ,KAAsB;AADjC,WADY,EAIZ,gCAAgBA,KAAhB,CAJY,CAAd;AAMA;;AACF,aAAK,SAAL;AACEJ,UAAAA,MAAM,CAACW,OAAP,GAAiBC,OAAO,CAACC,QAAQ,CAAC,4BAAYT,KAAZ,KAAsB,GAAvB,EAA4B,EAA5B,CAAT,CAAxB;AACA;;AACF,aAAK,OAAL;AACEJ,UAAAA,MAAM,CAACc,KAAP,mBAAe,4BAAYV,KAAZ,CAAf,uDAAqCW,SAArC;AACA;;AACF,aAAK,aAAL;AACEf,UAAAA,MAAM,CAACgB,WAAP,oBAAqB,4BAAYZ,KAAZ,CAArB,yDAA2CW,SAA3C;AACA;;AACF;AAAS;AACP,gBAAI,CAACf,MAAM,CAACiB,QAAZ,EAAsB;AACpBjB,cAAAA,MAAM,CAACiB,QAAP,GAAkB,EAAlB;AACD;;AAED,kBAAMC,KAAK,GAAG,4BAAYd,KAAZ,CAAd;;AAEA,gBAAIJ,MAAM,CAACiB,QAAP,CAAgBb,KAAK,CAACE,IAAtB,CAAJ,EAAiC;AAC/B,oBAAMa,KAAK,GAAGnB,MAAM,CAACiB,QAAP,CAAgBb,KAAK,CAACE,IAAtB,CAAd;;AACA,kBAAI,CAACc,KAAK,CAACC,OAAN,CAAcF,KAAd,CAAL,EAA2B;AACzBnB,gBAAAA,MAAM,CAACiB,QAAP,CAAgBb,KAAK,CAACE,IAAtB,IAA8B,CAACa,KAAD,CAA9B;AACD;;AAEAnB,cAAAA,MAAM,CAACiB,QAAP,CAAgBb,KAAK,CAACE,IAAtB,CAAD,CAA0CgB,IAA1C,CAA+CJ,KAA/C;AACD,aAPD,MAOO;AACLlB,cAAAA,MAAM,CAACiB,QAAP,CAAgBb,KAAK,CAACE,IAAtB,IAA8BY,KAA9B;AACD;;AAED,gBAAI,CAAC,CAAC,aAAD,EAAgBK,QAAhB,CAAyBnB,KAAK,CAACE,IAA/B,CAAL,EAA2C;AACzCkB,+BAAOC,KAAP,CAAc,6BAA4BrB,KAAK,CAACE,IAAK,GAArD,EADyC,CACiB;;AAC3D;;AACD;AACD;AAxCH;AA0CD,KA/CD;AAiDA,WAAON,MAAP;AACD;AAED;;;;;;;AAKA0B,EAAAA,iBAAiB,CAAC3B,QAAD,EAAW;AAC1B,UAAM4B,SAAS,GAAG,6BAAa5B,QAAb,EAAuB,WAAvB,CAAlB;;AACA,QAAI,EAAC4B,SAAD,aAACA,SAAD,uBAACA,SAAS,CAAEC,MAAZ,CAAJ,EAAwB;AACtB,aAAOb,SAAP;AACD;;AAED,WAAOY,SAAS,CAACE,GAAV,CAAeC,IAAD,IAAU;AAC7B,YAAM;AAAE5B,QAAAA;AAAF,UAAiB4B,IAAvB;AACA,YAAMC,UAAU,GAAG,KAAKC,qBAAL,CAA2BF,IAA3B,CAAnB;AACA,YAAMG,KAAK,GAAGzB,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBsB,UAAlB,CAAd,CAH6B,CAK7B;;AACA,UAAIA,UAAU,CAACG,QAAX,KAAwB,MAA5B,EAAoC;AAClC,cAAMC,MAAM,GAAG,0BAAUjC,UAAU,CAACkC,IAAX,CAAgBC,oBAAhB,CAAV,EAAsC,CACnD,UADmD,EAEnD,qBAFmD,EAGnD,YAHmD,CAAtC,CAAf;;AAMA,YAAIF,MAAJ,EAAY;AACV,gBAAM,CAACG,KAAD,EAAQhC,IAAR,IAAgB,CAAC,gBAAD,EAAmB,MAAnB,EAA2BuB,GAA3B,CAAgCU,OAAD,IACnD,4BAAY,0BAAUJ,MAAV,EAAkBI,OAAlB,CAAZ,CADoB,CAAtB;AAIA,gBAAMC,WAAW,GAAG3B,QAAQ,CAACyB,KAAD,EAAQ,EAAR,CAA5B;AAEAL,UAAAA,KAAK,CAACE,MAAN,GAAe;AAAEM,YAAAA,cAAc,EAAEC,KAAK,CAACF,WAAD,CAAL,GAAqB,CAArB,GAAyBA,WAA3C;AAAwDlC,YAAAA,IAAI,EAAEA,IAAI,IAAI;AAAtE,WAAf;AACD;AACF;;AAED,aAAO2B,KAAP;AACD,KAzBM,CAAP;AA0BD;AAED;;;;;;;AAKA,QAAMU,eAAN,CAAsBb,IAAtB,EAA4Bc,OAA5B,EAAqC;AACnC,QAAI,CAAC,KAAKC,mBAAL,CAAyBf,IAAzB,CAAL,EAAqC;AACnC,aAAOf,SAAP;AACD;;AAED,QAAIe,IAAI,CAACgB,SAAL,KAAmBC,0BAAiBC,MAAxC,EAAgD;AAC9C;AACA,YAAM,IAAIC,KAAJ,CAAU,gCAAV,CAAN;AACD,KARkC,CAUnC;;;AACA,QAAI,CAACnB,IAAI,CAACZ,KAAL,CAAWA,KAAhB,EAAuB;AACrBM,uBAAO0B,IAAP,CAAa,eAAcpB,IAAI,CAACqB,EAAL,CAAQjC,KAAM,yBAAzC;;AACA,aAAO0B,OAAO,CAACQ,MAAR,CAAetB,IAAf,CAAP;AACD;;AAED,UAAMuB,GAAG,GAAG,KAAKC,cAAL,CAAoBxB,IAApB,CAAZ;;AACA,QAAI,CAACuB,GAAL,EAAU;AACR,YAAM,IAAIJ,KAAJ,CAAU,sBAAV,CAAN;AACD;;AAED,UAAMlD,QAAQ,GAAG,0BAAUsD,GAAV,EAAe,QAAf,CAAjB;;AACA,QAAI,CAACtD,QAAL,EAAe;AACb,YAAM,IAAIkD,KAAJ,CAAW,qBAAoBnB,IAAI,CAACqB,EAAL,CAAQjC,KAAM,EAA7C,CAAN;AACD,KAxBkC,CA0BnC;;;AACA,UAAMlB,MAAM,mCACP,KAAKF,eAAL,CAAqBC,QAArB,CADO;AAEVwD,MAAAA,UAAU,EAAE,KAAK7B,iBAAL,CAAuB3B,QAAvB;AAFF,MAAZ,CA3BmC,CAgCnC;;;AACA,UAAMyD,UAAU,GAAI,KAAKC,WAAN,CAAkDC,SAAlD,CAA4D5B,IAA5D,EAAkE,OAAlE,CAAnB;AACA0B,IAAAA,UAAU,CAACtC,KAAX,GAAmB;AACjByC,MAAAA,QAAQ,EAAEC,kBAASC,MADF;AAEjBf,MAAAA,SAAS,EAAEC,0BAAiBC,MAFX;AAGjB9B,MAAAA,KAAK,EAAE4C,IAAI,CAACC,SAAL,CAAe/D,MAAf,EAAuB,IAAvB,EAA6B,IAA7B;AAHU,KAAnB;AAKA4C,IAAAA,OAAO,CAACoB,OAAR,CAAgBR,UAAhB,EAvCmC,CAyCnC;;AACA,UAAMS,QAAQ,GAAG,0BAAUlE,QAAV,EAAoB,MAApB,CAAjB;AACA,UAAMmE,UAAU,GAAI,KAAKT,WAAN,CAAkDC,SAAlD,CAA4D5B,IAA5D,EAAkE,KAAlE,CAAnB;AACAoC,IAAAA,UAAU,CAAChD,KAAX,GAAmB;AACjByC,MAAAA,QAAQ,EAAEC,kBAASC,MADF;AAEjBf,MAAAA,SAAS,EAAEC,0BAAiBC,MAFX;AAGjB9B,MAAAA,KAAK,EAAE,4BAAY+C,QAAZ,KAAyB;AAHf,KAAnB;AAKArB,IAAAA,OAAO,CAACoB,OAAR,CAAgBE,UAAhB;AAEA,WAAO,MAAMvB,eAAN,CAAsBb,IAAtB,EAA4Bc,OAA5B,CAAP;AACD;AAED;;;;;;;AAKAuB,EAAAA,YAAY,CAACrC,IAAD,EAAOsC,OAAP,EAAgB;AAC1B,UAAMZ,UAAU,GAAGY,OAAO,CAAC,OAAD,CAA1B;AACA,QAAIpE,MAA0B,GAAG,EAAjC;;AAEA,QAAIwD,UAAJ,EAAgB;AACd,UAAI;AACFxD,QAAAA,MAAM,GAAG8D,IAAI,CAACO,KAAL,CAAWb,UAAU,CAACc,WAAtB,CAAT;AACD,OAFD,CAEE,OAAOC,CAAP,EAAU;AACV,cAAM,IAAItB,KAAJ,CAAW,yBAAwBO,UAAU,CAACtB,QAAS,KAAIqC,CAAC,CAACC,OAAQ,EAArE,CAAN;AACD;AACF;;AAED,UAAMN,UAAU,GACdE,OAAO,CAAE,KAAKX,WAAN,CAAqD7D,qBAAtD,CADT;AAEA,QAAI6E,IAAI,GAAG,EAAX;;AAEA,QAAIP,UAAJ,EAAgB;AACdO,MAAAA,IAAI,GAAGP,UAAU,CAACI,WAAlB;AACD;;AAED,UAAMvE,QAAQ,GAAG,8BAAc,QAAd,EAAwB,EAAxB,CAAjB;AAEA,UAAM2E,MAAM,GAAG;AACbxE,MAAAA,UAAU,EAAE,CACV;AAAEG,QAAAA,IAAI,EAAE,WAAR;AAAqBa,QAAAA,KAAK,EAAE;AAA5B,OADU,EAEVnB,QAFU;AADC,KAAf,CAtB0B,CA6B1B;;AACA,UAAM4E,IAAI,GAAG,EAAb;;AAEA,QAAI7C,IAAI,CAAC8C,cAAT,EAAyB;AACvB;AACA,UAAI5E,MAAM,CAACO,IAAX,EAAiB;AACf,6BAAmCP,MAAM,CAACO,IAA1C;AAAA,cAAM;AAAEG,UAAAA;AAAF,SAAN;AAAA,cAAoBmE,UAApB;;AAEAF,QAAAA,IAAI,CAACrD,IAAL,CAAU,8BAAc,MAAd,EAAsB,CAAC,+BAAeZ,OAAf,CAAD,CAAtB,EAAiDmE,UAAjD,CAAV;AACD,OANsB,CAQvB;;;AACA,UAAI7E,MAAM,CAACW,OAAP,KAAmBI,SAAvB,EAAkC;AAChC4D,QAAAA,IAAI,CAACrD,IAAL,CAAU,8BAAc,SAAd,EAAyB,CAAC,+BAAgB,GAAEtB,MAAM,CAACW,OAAP,GAAiB,CAAjB,GAAqB,CAAE,EAAzC,CAAD,CAAzB,CAAV;AACD;;AAED,UAAIX,MAAM,CAACc,KAAP,KAAiBC,SAArB,EAAgC;AAC9B4D,QAAAA,IAAI,CAACrD,IAAL,CAAU,8BAAc,OAAd,EAAuB,CAAC,+BAAetB,MAAM,CAACc,KAAtB,CAAD,CAAvB,CAAV;AACD;;AAED,UAAId,MAAM,CAACgB,WAAP,KAAuBD,SAA3B,EAAsC;AACpC4D,QAAAA,IAAI,CAACrD,IAAL,CAAU,8BAAc,aAAd,EAA6B,CAAC,+BAAetB,MAAM,CAACgB,WAAtB,CAAD,CAA7B,CAAV;AACD;AACF,KApDyB,CAsD1B;;;AACA,QAAIhB,MAAM,CAACiB,QAAP,KAAoBF,SAAxB,EAAmC;AACjCP,MAAAA,MAAM,CAACsE,OAAP,CAAe9E,MAAM,CAACiB,QAAtB,EAAgCd,OAAhC,CAAwC,CAAC,CAACG,IAAD,EAAOY,KAAP,CAAD,KAAmB;AACzD,SAACE,KAAK,CAACC,OAAN,CAAcH,KAAd,IAAuBA,KAAvB,GAA+B,CAACA,KAAD,CAAhC,EAAyCf,OAAzC,CAAkD4E,CAAD,IAC/CJ,IAAI,CAACrD,IAAL,CAAU,8BAAchB,IAAd,EAAoB,CAAC,+BAAeyE,CAAf,CAAD,CAApB,CAAV,CADF;AAGD,OAJD;AAKD;;AAED,QAAIjD,IAAI,CAAC8C,cAAL,IAAuBD,IAAI,CAAC/C,MAAhC,EAAwC;AACtC,mCAAa7B,QAAb,EAAuB,8BAAc,UAAd,EAA0B4E,IAA1B,CAAvB;AACD,KAjEyB,CAmE1B;;;AACA,QAAI3E,MAAM,CAACuD,UAAX,EAAuB;AACrBvD,MAAAA,MAAM,CAACuD,UAAP,CAAkBpD,OAAlB,CAA2B4B,UAAD,IAAgB;AACxC,YAAIiD,QAAJ,CADwC,CAGxC;;AACA,YAAIjD,UAAU,CAACG,QAAX,KAAwB,MAA5B,EAAoC;AAClC,gBAAM;AAAEO,YAAAA,cAAF;AAAkBnC,YAAAA;AAAlB,cAA2ByB,UAAU,CAACI,MAAX,IAAqB,EAAtD;AACA,gBAAM8C,cAAc,GAAG,8BAAc,UAAd,CAAvB;AAEAD,UAAAA,QAAQ,GAAG,CAAC,8BAAc,cAAd,EAA8B,CAACC,cAAD,CAA9B,CAAD,CAAX;;AAEA,cAAI3E,IAAI,KAAKS,SAAb,EAAwB;AACtBkE,YAAAA,cAAc,CAAC/E,UAAf,GAA4B,CAC1B,8BAAc,qBAAd,EAAqC,CACnC,8BAAc,YAAd,EAA4B,CAC1B,8BAAc,gBAAd,EAAgC,CAAC,+BAAgB,GAAEuC,cAAe,EAAjC,CAAD,CAAhC,CAD0B,EAE1B,8BAAc,MAAd,EAAsB,CAAC,+BAAgB,GAAEnC,IAAK,EAAvB,CAAD,CAAtB,CAF0B,CAA5B,CADmC,CAArC,CAD0B,CAA5B;AAQD,WAfiC,CAiBlC;;;AACA,iBAAOyB,UAAU,CAACI,MAAlB;AACD;;AAED,oCAAYpC,QAAZ,EAAsB,8BAAc,WAAd,EAA2BiF,QAA3B,EAAqCjD,UAArC,CAAtB;AACD,OA1BD;AA2BD,KAhGyB,CAkG1B;;;AACA,gCAAYhC,QAAZ,EAAsB,8BAAc,MAAd,EAAsB,CAAC,gCAAgB0E,IAAhB,CAAD,CAAtB,CAAtB,EAnG0B,CAqG1B;;AACA3C,IAAAA,IAAI,CAACZ,KAAL,CAAWA,KAAX,GAAmB,KAAKgE,cAAL,CAAoBR,MAApB,CAAnB;AACD;;AAhSyD;AAmS5D;;;;;;;AAGO,MAAMS,uBAAN,SAAsCzF,uBAAtC,CAA8D;AACnE;AACA,aAAW0F,SAAX,GAAuB;AACrB,WAAO,SAAP;AACD;AAED;;;;;;;AAKAvC,EAAAA,mBAAmB,CAACf,IAAD,EAAO;AACxB,WAAOA,IAAI,CAACuD,UAAL,IAAmBvD,IAAI,CAACwD,QAA/B;AACD;;AAbkE;AAgBrE;;;;;;;AAGO,MAAMC,uBAAN,SAAsC7F,uBAAtC,CAA8D;AACnE;AACA,aAAW0F,SAAX,GAAuB;AACrB,WAAO,KAAP;AACD;AAED;;;;;;;AAKAvC,EAAAA,mBAAmB,CAACf,IAAD,EAAO;AACxB,WAAOA,IAAI,CAACuD,UAAL,IAAmBvD,IAAI,CAAC8C,cAA/B;AACD;;AAbkE;;;;AAgB9D,MAAMY,wBAAN,SAAuC9F,uBAAvC,CAA+D;AACpE;AACA,aAAW0F,SAAX,GAAuB;AACrB,WAAO,KAAP;AACD;AAED;;;;;;;AAKAvC,EAAAA,mBAAmB,CAACf,IAAD,EAAO;AACxB,WAAOA,IAAI,CAACuD,UAAL,IAAmBvD,IAAI,CAAC2D,eAA/B;AACD;;AAbmE","sourcesContent":["import Logger from 'gulplog';\nimport { DataType, VariantArrayType } from 'node-opcua/lib/datamodel/variant';\nimport {\n  findChild,\n  findChildren,\n  textContent,\n  createElement,\n  createTextNode,\n  createCDataNode,\n  prependChild,\n  appendChild,\n  isElement,\n  attributeValues,\n  AttributeValues,\n} from 'modify-xml';\nimport XMLTransformer from '../lib/transform/XMLTransformer';\nimport type SplittingTransformer from '../lib/transform/SplittingTransformer';\nimport type { ServerscriptConfig } from '../../types/schemas/serverscript-config';\n\n/**\n * A transformer that splits atvise scripts and quick dynamics into a code file and a .json file\n * containing parameters and metadata.\n */\nexport class AtviseScriptTransformer extends XMLTransformer {\n  /**\n   * The source file extension to allow for scripts.\n   */\n  static get scriptSourceExtension() {\n    return '.js';\n  }\n\n  /**\n   * The source file extensions to allow.\n   * @type {string[]}\n   */\n  static get sourceExtensions() {\n    return ['.json', this.scriptSourceExtension];\n  }\n\n  /**\n   * Extracts a script's metadata.\n   * @param {Object} document The parsed xml document to process.\n   * @return {Object} The metadata found.\n   */\n  processMetadata(document) {\n    const config: ServerscriptConfig = {};\n\n    const metaTag = findChild(document, 'metadata');\n    // console.error('Meta', metaTag);\n    if (!metaTag || !metaTag.childNodes) {\n      return config;\n    }\n\n    metaTag.childNodes.forEach((child) => {\n      if (child.type !== 'element') {\n        return;\n      }\n\n      switch (child.name) {\n        case 'icon':\n          config.icon = Object.assign(\n            {\n              content: textContent(child) || '',\n            },\n            attributeValues(child) as { [name: string]: string } & { type: string }\n          );\n          break;\n        case 'visible':\n          config.visible = Boolean(parseInt(textContent(child) || '1', 10));\n          break;\n        case 'title':\n          config.title = textContent(child) ?? undefined;\n          break;\n        case 'description':\n          config.description = textContent(child) ?? undefined;\n          break;\n        default: {\n          if (!config.metadata) {\n            config.metadata = {};\n          }\n\n          const value = textContent(child)!;\n\n          if (config.metadata[child.name]) {\n            const soFar = config.metadata[child.name];\n            if (!Array.isArray(soFar)) {\n              config.metadata[child.name] = [soFar];\n            }\n\n            (config.metadata[child.name] as string[]).push(value);\n          } else {\n            config.metadata[child.name] = value;\n          }\n\n          if (!['longrunning'].includes(child.name)) {\n            Logger.debug(`Generic metadata element '${child.name}'`); // FIXME:  at ${node.nodeId}\n          }\n          break;\n        }\n      }\n    });\n\n    return config;\n  }\n\n  /**\n   * Extracts a script's parameters.\n   * @param {Object} document The parsed xml document to process.\n   * @return {Object[]} The parameters found.\n   */\n  processParameters(document) {\n    const paramTags = findChildren(document, 'parameter');\n    if (!paramTags?.length) {\n      return undefined;\n    }\n\n    return paramTags.map((node) => {\n      const { childNodes } = node;\n      const attributes = this.sortedAttributeValues(node);\n      const param = Object.assign({}, attributes) as ServerscriptConfig['parameters'][0];\n\n      // Handle relative parameter targets\n      if (attributes.relative === 'true') {\n        const target = findChild(childNodes.find(isElement), [\n          'Elements',\n          'RelativePathElement',\n          'TargetName',\n        ]);\n\n        if (target) {\n          const [index, name] = ['NamespaceIndex', 'Name'].map((tagName) =>\n            textContent(findChild(target, tagName))\n          );\n\n          const parsedIndex = parseInt(index, 10);\n\n          param.target = { namespaceIndex: isNaN(parsedIndex) ? 1 : parsedIndex, name: name || '' };\n        }\n      }\n\n      return param;\n    });\n  }\n\n  /**\n   * Splits a node into multiple source nodes.\n   * @param {Node} node A server node.\n   * @param {Object} context The current transform context.\n   */\n  async transformFromDB(node, context) {\n    if (!this.shouldBeTransformed(node)) {\n      return undefined;\n    }\n\n    if (node.arrayType !== VariantArrayType.Scalar) {\n      // FIXME: Instead of throwing we could simply pass the original node to the callback\n      throw new Error('Array of scripts not supported');\n    }\n\n    // If scripts are empty (e.g. created by atvise builder, but never edited) we display a warning and ignore them.\n    if (!node.value.value) {\n      Logger.warn(`The script '${node.id.value}' is empty, skipping...`);\n      return context.remove(node);\n    }\n\n    const xml = this.decodeContents(node);\n    if (!xml) {\n      throw new Error('Error parsing script');\n    }\n\n    const document = findChild(xml, 'script');\n    if (!document) {\n      throw new Error(`Empty document at ${node.id.value}`);\n    }\n\n    // Extract metadata and parameters\n    const config = {\n      ...this.processMetadata(document),\n      parameters: this.processParameters(document),\n    };\n\n    // Write config file\n    const configFile = (this.constructor as typeof SplittingTransformer).splitFile(node, '.json');\n    configFile.value = {\n      dataType: DataType.String,\n      arrayType: VariantArrayType.Scalar,\n      value: JSON.stringify(config, null, '  '),\n    };\n    context.addNode(configFile);\n\n    // Write JavaScript file\n    const codeNode = findChild(document, 'code');\n    const scriptFile = (this.constructor as typeof SplittingTransformer).splitFile(node, '.js');\n    scriptFile.value = {\n      dataType: DataType.String,\n      arrayType: VariantArrayType.Scalar,\n      value: textContent(codeNode) || '',\n    };\n    context.addNode(scriptFile);\n\n    return super.transformFromDB(node, context);\n  }\n\n  /**\n   * Inlines the passed source nodes to the given container node.\n   * @param {Node} node The container node.\n   * @param {{ [ext: string]: Node }} sources The source nodes to inline.\n   */\n  combineNodes(node, sources) {\n    const configFile = sources['.json'];\n    let config: ServerscriptConfig = {};\n\n    if (configFile) {\n      try {\n        config = JSON.parse(configFile.stringValue);\n      } catch (e) {\n        throw new Error(`Error parsing JSON in ${configFile.relative}: ${e.message}`);\n      }\n    }\n\n    const scriptFile =\n      sources[(this.constructor as typeof AtviseScriptTransformer).scriptSourceExtension];\n    let code = '';\n\n    if (scriptFile) {\n      code = scriptFile.stringValue;\n    }\n\n    const document = createElement('script', []);\n\n    const result = {\n      childNodes: [\n        { type: 'directive', value: '<?xml version=\"1.0\" encoding=\"UTF-8\"?>' },\n        document,\n      ],\n    };\n\n    // Insert metadata\n    const meta = [];\n\n    if (node.isQuickDynamic) {\n      // - Icon\n      if (config.icon) {\n        const { content, ...iconConfig } = config.icon;\n\n        meta.push(createElement('icon', [createTextNode(content)], iconConfig as AttributeValues));\n      }\n\n      // - Other fields\n      if (config.visible !== undefined) {\n        meta.push(createElement('visible', [createTextNode(`${config.visible ? 1 : 0}`)]));\n      }\n\n      if (config.title !== undefined) {\n        meta.push(createElement('title', [createTextNode(config.title)]));\n      }\n\n      if (config.description !== undefined) {\n        meta.push(createElement('description', [createTextNode(config.description)]));\n      }\n    }\n\n    // - Additional fields\n    if (config.metadata !== undefined) {\n      Object.entries(config.metadata).forEach(([name, value]) => {\n        (Array.isArray(value) ? value : [value]).forEach((v) =>\n          meta.push(createElement(name, [createTextNode(v)]))\n        );\n      });\n    }\n\n    if (node.isQuickDynamic || meta.length) {\n      prependChild(document, createElement('metadata', meta));\n    }\n\n    // Insert parameters\n    if (config.parameters) {\n      config.parameters.forEach((attributes) => {\n        let elements;\n\n        // Handle relative parameter targets\n        if (attributes.relative === 'true') {\n          const { namespaceIndex, name } = attributes.target || {};\n          const targetElements = createElement('Elements');\n\n          elements = [createElement('RelativePath', [targetElements])];\n\n          if (name !== undefined) {\n            targetElements.childNodes = [\n              createElement('RelativePathElement', [\n                createElement('TargetName', [\n                  createElement('NamespaceIndex', [createTextNode(`${namespaceIndex}`)]),\n                  createElement('Name', [createTextNode(`${name}`)]),\n                ]),\n              ]),\n            ];\n          }\n\n          // eslint-disable-next-line no-param-reassign\n          delete attributes.target;\n        }\n\n        appendChild(document, createElement('parameter', elements, attributes as AttributeValues));\n      });\n    }\n\n    // Insert script code\n    appendChild(document, createElement('code', [createCDataNode(code)]));\n\n    // eslint-disable-next-line no-param-reassign\n    node.value.value = this.encodeContents(result);\n  }\n}\n\n/**\n * A transformer that splits atvise server scripts into multiple files.\n */\nexport class ServerscriptTransformer extends AtviseScriptTransformer {\n  /** The container's extension. */\n  static get extension() {\n    return '.script';\n  }\n\n  /**\n   * Returns `true` for all script nodes.\n   * @param {Node} node The node to check.\n   * @return {boolean} If the node is a server script.\n   */\n  shouldBeTransformed(node) {\n    return node.isVariable && node.isScript;\n  }\n}\n\n/**\n * A transformer that splits atvise quickdynamics into multiple files.\n */\nexport class QuickDynamicTransformer extends AtviseScriptTransformer {\n  /** The container's extension. */\n  static get extension() {\n    return '.qd';\n  }\n\n  /**\n   * Returns `true` for all nodes containing quick dynamics.\n   * @param {Node} node The node to check.\n   * @return {boolean} If the node is a quick dynamic.\n   */\n  shouldBeTransformed(node) {\n    return node.isVariable && node.isQuickDynamic;\n  }\n}\n\nexport class DisplayScriptTransformer extends AtviseScriptTransformer {\n  /** The container's extension. */\n  static get extension() {\n    return '.ds';\n  }\n\n  /**\n   * Returns `true` for all nodes containing quick dynamics.\n   * @param {Node} node The node to check.\n   * @return {boolean} If the node is a quick dynamic.\n   */\n  shouldBeTransformed(node) {\n    return node.isVariable && node.isDisplayScript;\n  }\n}\n"],"file":"ScriptTransformer.js"}