machine:
  environment:
    # Save mocha test results
    MOCHA_FILE: "$CIRCLE_TEST_REPORTS/mocha.xml"

dependencies:
  post:
    # For some reason this plugin is not automatically installed inside the CircleCI container
    - npm install eslint-plugin-import@latest
    # Needed for proper mocha test results
    - npm install mocha-circleci-reporter

test:
  override:
    # Run mocha tests
    - npm test -- --reporter mocha-circleci-reporter
    # Lint files
    - node_modules/.bin/eslint -f junit src > $CIRCLE_TEST_REPORTS/eslint.xml
    # Test coverage
    - node_modules/.bin/nyc --reporter=text-lcov > $CIRCLE_ARTIFACTS/coverage.lcov npm test
  post:
    # Create coverage report
    - bash <(curl -s https://codecov.io/bash)
    # Create API docs and save them to artifacts
    - npm run docs
    - cp -R docs $CIRCLE_ARTIFACTS

